<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Info System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow-x: hidden;
            /* Ensure fixed elements stay in viewport */
            position: relative;
            /* Prevent any content from affecting viewport */
            min-width: 100vw;
            max-width: 100vw;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8fafc;
            color: #1e293b;
            line-height: 1.6;
        }

        /* Login Page */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100vw;
            height: 100vh;
            z-index: 9999;
            margin: 0;
            box-sizing: border-box;
        }

        .login-card {
            background: white;
            padding: 48px;
            border-radius: 16px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            width: 100%;
            max-width: 420px;
            position: relative;
            overflow: hidden;
        }

        .login-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }

        .login-tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 2px solid #e5e7eb;
        }

        .tab-btn {
            flex: 1;
            padding: 12px 20px;
            background: none;
            border: none;
            font-size: 16px;
            font-weight: 600;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .tab-btn:hover {
            color: #374151;
            background-color: #f9fafb;
        }

        .tab-btn.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
            background-color: #eff6ff;
        }

        .login-title {
            text-align: center;
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 32px;
            color: #1e293b;
            letter-spacing: -0.025em;
        }

        .input-group {
            margin-bottom: 24px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .input-field {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            background-color: #f9fafb;
            font-size: 16px;
            color: #1e293b;
            outline: none;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .input-field:focus {
            border-color: #667eea;
            background-color: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .input-field::placeholder {
            color: #9ca3af;
        }

        .login-btn {
            width: 100%;
            padding: 16px;
            background: #667eea;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .login-btn:hover {
            background: #5a67d8;
            transform: translateY(-1px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        /* Dashboard Layout */
        .app-container {
            min-height: 100vh;
            background: #f8fafc;
            display: flex;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: white;
            border-right: 1px solid #e5e7eb;
            padding: 24px 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }

        .sidebar-header {
            padding: 0 24px 24px;
            border-bottom: 1px solid #e5e7eb;
            margin-bottom: 24px;
        }

        .sidebar-title {
            font-size: 20px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 4px;
        }

        .sidebar-subtitle {
            font-size: 14px;
            color: #6b7280;
        }

        .nav-menu {
            padding: 0 16px;
        }

        .nav-item {
            margin-bottom: 8px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border-radius: 8px;
            color: #6b7280;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .nav-link:hover {
            background: #f3f4f6;
            color: #374151;
        }

        .nav-link.active {
            background: #667eea;
            color: white;
        }

        .nav-icon {
            width: 20px;
            height: 20px;
            margin-right: 12px;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 32px;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
            padding-bottom: 24px;
            border-bottom: 1px solid #e5e7eb;
        }

        .page-title {
            font-size: 32px;
            font-weight: 700;
            color: #1e293b;
            margin: 0;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #667eea;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .user-details {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-weight: 600;
            color: #1e293b;
            font-size: 14px;
        }

        .user-role {
            font-size: 12px;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .logout-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .logout-btn:hover {
            background: #dc2626;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            border: 1px solid #e5e7eb;
            overflow: hidden;
        }

        .card-header {
            padding: 24px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: #1e293b;
            margin: 0;
        }

        .card-content {
            padding: 24px;
        }

        /* Student Dashboard Tabs */
        .student-tabs {
            display: flex;
            border-bottom: 2px solid #e5e7eb;
            margin-bottom: 20px;
        }

        .tab-btn {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: #6b7280;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .tab-btn:hover {
            color: #374151;
            background-color: #f9fafb;
        }

        .tab-btn.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
            background-color: #eff6ff;
        }

        .tab-content {
            display: block;
        }

        .tab-content.hidden {
            display: none;
        }

        /* Student Navigation */
        .student-nav {
            display: flex;
            background: white;
            border-bottom: 1px solid #e5e7eb;
            padding: 0 24px;
        }

        .student-nav .nav-item {
            margin: 0;
        }

        .student-nav .nav-link {
            padding: 16px 24px;
            color: #6b7280;
            text-decoration: none;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .student-nav .nav-link:hover {
            color: #374151;
            background-color: #f9fafb;
        }

        .student-nav .nav-link.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
            background-color: #eff6ff;
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            border: none;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a67d8;
            transform: translateY(-1px);
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
            transform: translateY(-1px);
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
            transform: translateY(-1px);
        }

        .btn-warning {
            background: #f59e0b;
            color: white;
        }

        .btn-warning:hover {
            background: #d97706;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
            transform: translateY(-1px);
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th, td {
            padding: 16px;
            text-align: left;
            border-bottom: 1px solid #f3f4f6;
        }

        th {
            background: #f9fafb;
            font-weight: 600;
            color: #374151;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        tr:hover {
            background: #f9fafb;
        }

        /* Status badges */
        .badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .badge-success {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-warning {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-danger {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-header {
            padding: 24px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #1e293b;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #6b7280;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: #f3f4f6;
            color: #374151;
        }

        .modal-body {
            padding: 24px;
        }

        .modal-footer {
            padding: 24px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        /* Form elements */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }
        }

        .menu-buttons {
            display: flex;
            flex-direction: row;
            gap: 40px;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
        }

        .menu-btn {
            padding: 30px 60px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 1.3rem;
            font-weight: 700;
            border: none;
            transition: all 0.4s ease;
            width: 320px;
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }

        .menu-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .menu-btn:hover::before {
            left: 100%;
        }

        .active-students-btn {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
        }

        .active-students-btn:hover {
            background: linear-gradient(135deg, #229954 0%, #27ae60 100%);
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(39, 174, 96, 0.4);
        }

        .data-log-btn {
            background: linear-gradient(135deg, #e67e22 0%, #f39c12 100%);
            color: white;
        }

        .data-log-btn:hover {
            background: linear-gradient(135deg, #d35400 0%, #e67e22 100%);
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(230, 126, 34, 0.4);
        }

        .page-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
        }

        .back-btn {
            background-color: #666;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        .back-btn:hover {
            background-color: #555;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 25px 30px;
            border-radius: 15px;
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .header h1 {
            margin: 0;
            font-size: 2.5rem;
            font-weight: 700;
            color: white;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .user-info {
            position: fixed;
            top: 0;
            right: 0;
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 9999;
            background: rgba(255, 255, 255, 0.98);
            padding: 15px 20px;
            border-radius: 0 0 0 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            max-width: 300px;
            overflow: hidden;
            pointer-events: auto;
        }

        @media (max-width: 1200px) {
            .user-info {
                top: 0;
                right: 0;
            }
        }

        @media (max-width: 768px) {
            .user-info {
                position: relative;
                top: auto;
                right: auto;
                margin-bottom: 20px;
                max-width: 100%;
                z-index: auto;
            }
        }

        @media (max-width: 400px) {
            .user-info {
                position: relative;
                top: auto;
                right: auto;
                margin-bottom: 20px;
                max-width: 100%;
                z-index: auto;
            }
        }

        .signed-in-text {
            font-weight: 700;
            color: #2c3e50;
            font-size: 0.95rem;
        }

        .logout-btn {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 700;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
            white-space: nowrap;
            min-width: fit-content;
        }

        @media (max-width: 480px) {
            .logout-btn {
                padding: 10px 16px;
                font-size: 0.8rem;
            }
        }

        /* Move entire teacher dashboard 20px to the left to reduce gap */
        #teacherDashboardPage {
            margin-left: -20px !important;
        }
        
        /* Teacher Dashboard specific responsive fixes */
        @media (max-width: 1200px) {
            #teacherDashboardPage .card-content {
                overflow-x: auto;
                /* Ensure logout button stays visible */
                position: relative;
                /* Prevent horizontal overflow from affecting viewport */
                max-width: calc(100vw - 320px);
            }
            
            #teacherDashboardPage table {
                min-width: 800px;
            }
            
            /* Force logout button to stay in viewport */
            #teacherDashboardPage .user-info {
                position: fixed !important;
                top: 20px !important;
                left: 10px !important;
                z-index: 99999 !important;
                /* Fixed size and position */
                width: 280px !important;
                height: 60px !important;
                overflow: hidden !important;
            }
        }

        @media (max-width: 768px) {
            #teacherDashboardPage .card-content {
                padding: 15px;
            }
            
            .user-info {
                position: relative;
                top: auto;
                right: auto;
                margin-bottom: 20px;
                max-width: 100%;
            }
        }

        /* Ensure consistent logout button positioning across all pages */
        .user-info {
            position: fixed !important;
            top: 20px !important;
            left: 20px !important;
            z-index: 9999 !important;
            background: rgba(255, 255, 255, 0.98) !important;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2) !important;
            width: 280px !important;
            height: 60px !important;
            overflow: hidden !important;
            border-radius: 15px !important;
            /* Fixed position */
            transform: none !important;
        }

        @media (max-width: 768px) {
            .user-info {
                position: relative !important;
                top: auto !important;
                right: auto !important;
                margin-bottom: 20px !important;
                max-width: 100% !important;
                border-radius: 15px !important;
            }
        }

        /* Ensure logout button is always visible */
        .logout-btn {
            position: relative !important;
            z-index: 10000 !important;
            white-space: nowrap !important;
            min-width: fit-content !important;
        }

        /* FIXED LOCATION: Logout button at specific coordinates */
        .user-info {
            position: fixed !important;
            top: 20px !important;
            left: 20px !important;
            z-index: 999999 !important;
            width: 280px !important;
            height: 60px !important;
            overflow: hidden !important;
            background: rgba(255, 255, 255, 0.98) !important;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2) !important;
            border-radius: 15px !important;
            /* Fixed size and position */
            transform: none !important;
            right: auto !important;
            bottom: auto !important;
            /* Prevent any interference */
            pointer-events: auto !important;
            display: flex !important;
            align-items: center !important;
            gap: 15px !important;
            padding: 15px 20px !important;
        }

        /* Force logout button to stay in viewport on all pages */
        .user-info {
            position: fixed !important;
            top: 20px !important;
            left: 20px !important;
            z-index: 99999 !important;
            /* Prevent any content from affecting its position */
            transform: none !important;
            will-change: transform !important;
            /* Ensure it's always in the visible viewport */
            width: 280px !important;
            height: 60px !important;
            overflow: hidden !important;
            background: rgba(255, 255, 255, 0.98) !important;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2) !important;
            border-radius: 15px !important;
            /* Force it to stay within viewport bounds */
            right: auto !important;
            bottom: auto !important;
        }

        .logout-btn:hover {
            background: linear-gradient(135deg, #c0392b 0%, #a93226 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(231, 76, 60, 0.4);
        }

        /* FINAL OVERRIDE: Force top-left positioning */
        .user-info {
            position: fixed !important;
            top: 20px !important;
            left: 855px !important;
            right: auto !important;
            bottom: auto !important;
            z-index: 999999 !important;
            width: 280px !important;
            height: 60px !important;
            background: rgba(255, 255, 255, 0.98) !important;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2) !important;
            border-radius: 15px !important;
            overflow: hidden !important;
            display: flex !important;
            align-items: center !important;
            gap: 15px !important;
            padding: 15px 20px !important;
            pointer-events: auto !important;
        }

        .main-content {
            background: rgba(255, 255, 255, 0.95);
            padding: 35px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-top: 80px;
        }

        @media (max-width: 768px) {
            .main-content {
                margin-top: 20px;
            }
        }

        .content-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f1f3f4;
        }

        .content-title {
            font-size: 2.2rem;
            font-weight: 700;
            color: #2c3e50;
            margin: 0;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .add-btn {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 700;
            min-width: 140px;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }

        .add-btn:hover {
            background: linear-gradient(135deg, #2980b9 0%, #1f5f8b 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(52, 152, 219, 0.4);
        }

        .subtitle {
            color: #666;
            font-size: 1rem;
            margin: 0;
        }

        .tabs {
            display: none;
        }

        .tab-content {
            display: block;
            background: white;
            padding: 0;
            box-shadow: none;
        }

        .tab-content.active {
            display: block;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 25px;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
            border: 1px solid #e9ecef;
        }

        th, td {
            padding: 18px 20px;
            text-align: left;
            border-bottom: 1px solid #f1f3f4;
            font-weight: 500;
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 700;
            font-size: 1.1rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        tr {
            transition: all 0.3s ease;
        }

        tr:hover {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        tr:nth-child(even) {
            background: #fafbfc;
        }

        tr:nth-child(even):hover {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }

        .error {
            color: #dc3545;
            background: #f8d7da;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border: 1px solid #f5c6cb;
        }

        .success {
            color: #155724;
            background: #d4edda;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border: 1px solid #c3e6cb;
        }

        .details-btn {
            background-color: #6e60bf; /* Purple */
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        .student-row:hover .details-btn {
            opacity: 1;
        }
        
        /* Make details buttons always visible in data log */
        #logTable .details-btn {
            opacity: 1;
            position: static;
            transform: none;
        }

        .student-row {
            transition: background-color 0.2s ease;
        }

        .student-row:hover {
            background-color: #f8f9fa;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 20px;
            max-width: 600px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
        }

        .modal-close {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            font-size: 20px;
            color: #f44336;
            cursor: pointer;
            font-weight: bold;
        }

        .modal-section {
            margin-bottom: 20px;
        }

        .modal-label {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .modal-value {
            color: #666;
            margin-bottom: 10px;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        .edit-btn {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 700;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
        }

        .edit-btn:hover {
            background: linear-gradient(135deg, #229954 0%, #27ae60 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(39, 174, 96, 0.4);
        }

        .delete-btn {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 700;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }

        .delete-btn:hover {
            background: linear-gradient(135deg, #c0392b 0%, #a93226 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(231, 76, 60, 0.4);
        }

        .recover-btn {
            background-color: #6e60bf;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            font-weight: bold;
        }

        .recover-btn:hover {
            background-color: #5a4f9e;
        }

        .recover-btn-disabled {
            background-color: #ccc;
            color: #666;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .edit-btn-disabled {
            background-color: #ccc;
            color: #666;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .delete-btn-disabled {
            background-color: #ccc;
            color: #666;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .undo-btn {
            background-color: #6e60bf; /* Purple - same as details button */
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            transition: all 0.3s ease;
            transform: scale(1);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .undo-btn:hover {
            background-color: #5a4f9e;
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .undo-btn:active {
            transform: scale(0.95);
            transition: all 0.1s ease;
        }
        .undo-btn-disabled {
            background-color: #ccc;
            color: #666;
            cursor: not-allowed;
            opacity: 0.7;
            transform: scale(1);
            box-shadow: none;
        }
        .undo-btn-disabled:hover {
            background-color: #ccc;
            transform: scale(1);
            box-shadow: none;
        }

        .clear-log-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .clear-log-btn:hover {
            background-color: #c82333;
            transform: scale(1.05);
        }
    </style>
</head>
<body>
    <!-- Login Form -->
            <div id="loginForm" class="login-container">
            <div class="login-card">
                <h1 class="login-title">Student Management System</h1>
                
                <!-- Login Type Tabs -->
                <div class="login-tabs">
                    <button class="tab-btn active" onclick="switchLoginTab('staff')" id="staffTab">Teacher/Admin</button>
                    <button class="tab-btn" onclick="switchLoginTab('student')" id="studentTab">Parent/Student</button>
                </div>
                
                <div id="staffLoginFields">
                    <div class="input-group">
                        <label for="username">Username</label>
                        <input type="text" id="username" class="input-field" placeholder="Enter your username">
                    </div>
                    <div class="input-group">
                        <label for="password">Password</label>
                        <input type="password" id="password" class="input-field" placeholder="Enter your password">
                    </div>
                </div>
                                 <div id="studentLoginFields" style="display: none;">
                     <div class="input-group">
                         <label for="studentFirstName">First Name</label>
                         <input type="text" id="studentFirstName" class="input-field" placeholder="Enter your first name">
                     </div>
                     <div class="input-group">
                         <label for="studentPassword">Password</label>
                         <input type="password" id="studentPassword" class="input-field" placeholder="Enter your password">
                     </div>
                 </div>
                <button onclick="login()" class="login-btn">Sign In</button>
                <div id="loginError" class="error" style="display: none;"></div>
            </div>
        </div>

    <!-- Main App -->
    <div id="appContainer" class="app-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">Student Management</div>
                <div class="sidebar-subtitle">Administrative Dashboard</div>
            </div>
            <nav class="nav-menu">
                <!-- Staff Navigation -->
                <div class="nav-item" id="activeStudentsNav">
                    <a href="#" class="nav-link active" onclick="showActiveStudents()">
                        <svg class="nav-icon" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        Active Students
                    </a>
                </div>
                <div class="nav-item" id="dataLogNav">
                    <a href="#" class="nav-link" onclick="showDataLog()">
                        <svg class="nav-icon" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
                            <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"/>
                        </svg>
                        Data Log
                    </a>
                </div>
                <div class="nav-item" id="teacherDashboardNav" style="display: none;">
                    <a href="#" class="nav-link" onclick="showTeacherDashboard()">
                        <svg class="nav-icon" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M10.394 2.08a1 1 0 00-.788 0l-7 3a1 1 0 000 1.84L5.25 8.051a.999.999 0 01.356-.257l4-1.714a1 1 0 11.788 1.838L7.667 9.088l1.94.831a1 1 0 00.787 0l7-3a1 1 0 000-1.838l-7-3zM3.31 9.397L5 10.12v4.102a8.969 8.969 0 00-1.05-.174 1 1 0 01-.89-.89 11.115 11.115 0 01.25-3.762zM9.3 16.573A9.026 9.026 0 007 14.935v-3.957l1.818.78a3 3 0 002.364 0l5.508-2.361a11.026 11.026 0 01.25 3.762 1 1 0 01-.89.89 8.968 8.968 0 00-5.35 2.524 1 1 0 01-1.4 0zM6 18a1 1 0 001-1v-2.065a8.935 8.935 0 00-2-.712V17a1 1 0 001 1z"/>
                        </svg>
                        My Class
                    </a>
                </div>
                <div class="nav-item" id="teacherManagementNav" style="display: none;">
                    <a href="#" class="nav-link" onclick="showTeacherManagement()">
                        <svg class="nav-icon" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z"/>
                        </svg>
                        Teacher Management
                    </a>
                </div>

                <!-- Student Navigation -->
                <div class="nav-item" id="studentAttendanceNav" style="display: none;">
                    <a href="#" class="nav-link active" onclick="showStudentAttendance()">
                        <svg class="nav-icon" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
                        </svg>
                        Attendance
                    </a>
                </div>
                <div class="nav-item" id="studentGradesNav" style="display: none;">
                    <a href="#" class="nav-link" onclick="showStudentGrades()">
                        <svg class="nav-icon" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        Grades
                    </a>
                </div>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Header -->
            <div class="page-header">
                <h1 class="page-title">Dashboard</h1>
                <div class="user-info">
                    <div class="user-avatar">
                        <span id="userInitial">U</span>
                    </div>
                    <div class="user-details">
                        <div class="user-name" id="userName">User</div>
                        <div class="user-role" id="userRole">Role</div>
                    </div>
                    <button onclick="logout()" class="logout-btn">Logout</button>
                </div>
            </div>

            <!-- Active Students Page -->
            <div id="activeStudentsPage" class="page-content" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Active Students</h2>
                        <button onclick="showAddStudentForm()" class="btn btn-primary">Add Student</button>
                    </div>
                    <div class="card-content">
                        <div id="studentsTable"></div>
                    </div>
                </div>
            </div>

            <!-- Data Log Page -->
            <div id="dataLogPage" class="page-content" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Data Log</h2>
                        <button onclick="clearDataLog()" class="btn btn-danger">Clear Log</button>
                    </div>
                    <div class="card-content">
                        <div id="logTable"></div>
                    </div>
                </div>
            </div>

            <!-- Teacher Management Page -->
            <div id="teacherManagementPage" class="page-content" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Teacher Management</h2>
                        <button onclick="showAddTeacherForm()" class="btn btn-primary">Add Teacher</button>
                    </div>
                    <div class="card-content">
                        <div id="teachersTable"></div>
                    </div>
                </div>
            </div>

            <!-- Teacher Dashboard Page -->
            <div id="teacherDashboardPage" class="page-content" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">My Class Dashboard</h2>
                        <div id="teacherClassInfo" style="color: #666; font-size: 14px;"></div>
                    </div>
                    <div class="card-content">
                        <div style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <label style="font-weight: 600; color: #374151;">Sort by:</label>
                            <select id="sortSelect" onchange="sortStudents()" style="padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;">
                                <option value="roll">Roll Number</option>
                                <option value="name">Name</option>
                                <option value="age">Age</option>
                                <option value="average">Average</option>
                                <option value="math">Math Marks</option>
                                <option value="science">Science Marks</option>
                                <option value="history">History Marks</option>
                                <option value="english">English Marks</option>
                            </select>
                            <button id="reverseSortBtn" onclick="reverseSort()" style="padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; background: #f8f9fa; cursor: pointer; font-size: 14px;" title="Reverse sort order">
                                ↕️
                            </button>
                        </div>
                        <div id="teacherStudentsTable"></div>
                    </div>
                </div>
            </div>

            <!-- Student Dashboard Page -->
            <div id="studentDashboardPage" class="page-content" style="display: none;">
                <!-- Attendance Page -->
                <div id="studentAttendancePage" class="page-content">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Attendance Tracking</h2>
                            <div id="studentInfo" style="color: #666; font-size: 14px;"></div>
                        </div>
                        <div class="card-content">
                            <div class="attendance-section">
                                <h3>Mark Your Attendance</h3>
                                <div class="webcam-container">
                                    <video id="webcam" autoplay playsinline style="width: 100%; max-width: 400px; border: 2px solid #ddd; border-radius: 8px;"></video>
                                    <canvas id="canvas" style="display: none;"></canvas>
                                    <div class="webcam-controls">
                                        <button id="startWebcam" onclick="startWebcam()" class="btn btn-primary">Start Camera</button>
                                        <button id="markAttendance" onclick="markAttendance()" class="btn btn-success" style="display: none;">Mark Attendance</button>
                                        <button id="stopWebcam" onclick="stopWebcam()" class="btn btn-secondary" style="display: none;">Stop Camera</button>
                                    </div>
                                    <div id="attendanceStatus" style="margin-top: 10px; padding: 10px; border-radius: 5px; display: none;"></div>
                                    <div id="attemptsRemaining" style="margin-top: 5px; padding: 8px; border-radius: 5px; display: none; font-size: 12px; font-weight: bold;"></div>
                                </div>
                            </div>
                            
                            <div class="attendance-history">
                                <h3>Attendance History</h3>
                                <div id="attendanceHistory"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Grades Page -->
                <div id="studentGradesPage" class="page-content" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">My Grades</h2>
                        </div>
                        <div class="card-content">
                            <div id="studentGrades"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let students = []; // Global students array for better performance
        let teacherStudents = []; // Global teacher students array for sorting
        let sortDirection = 'asc'; // Global sort direction

        // Function to calculate grade based on marks
        function calculateGrade(marks) {
            if (marks >= 90) return 'A';
            else if (marks >= 80) return 'B';
            else if (marks >= 70) return 'C';
            else if (marks >= 60) return 'D';
            else return 'F';
        }

        // Check login status on page load
        window.onload = async function() {
            try {
                const response = await fetch('/api/whoami');
                if (response.ok) {
                    const user = await response.json();
                    currentUser = user;
                    
                    // Check if student needs to set up profile picture
                    if (user.role === 'student') {
                        const profileResponse = await fetch('/api/student/profile-picture');
                        if (profileResponse.ok) {
                            const profileData = await profileResponse.json();
                            if (!profileData.has_profile_picture) {
                                // Redirect to profile setup page
                                window.location.href = '/profile-setup';
                                return;
                            }
                        }
                    }
                    
                    showApp();
                    if (user.role === 'student') {
                        showStudentDashboard();
                        // Check attempts remaining for today
                        checkAttemptsRemaining();
                    } else {
                        loadStudents();
                    }
                } else {
                    showLogin();
                }
            } catch (error) {
                console.error('Error checking login status:', error);
                showLogin();
            }
        };

        async function login() {
            const staffTab = document.getElementById('staffTab');
            const isStaffLogin = staffTab.classList.contains('active');
            const errorDiv = document.getElementById('loginError');

            try {
                let response;
                if (!isStaffLogin) {
                    const firstName = document.getElementById('studentFirstName').value;
                    const password = document.getElementById('studentPassword').value;
                    
                    if (!firstName || !password) {
                        errorDiv.textContent = 'Please enter first name and password';
                        errorDiv.style.display = 'block';
                        return;
                    }

                    response = await fetch('/api/student/login', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ first_name: firstName, password })
                    });
                } else {
                    const username = document.getElementById('username').value;
                    const password = document.getElementById('password').value;
                    
                    if (!username || !password) {
                        errorDiv.textContent = 'Please enter username and password';
                        errorDiv.style.display = 'block';
                        return;
                    }

                    response = await fetch('/api/login', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ username, password })
                    });
                }

                if (response.ok) {
                    const user = await response.json();
                    currentUser = user;
                    errorDiv.style.display = 'none';
                    
                    // Check if student needs to set up profile picture
                    if (user.role === 'student' && user.needs_profile_picture) {
                        // Redirect to profile setup page
                        window.location.href = '/profile-setup';
                        return;
                    }
                    
                    showApp();
                    if (user.role === 'student') {
                        showStudentDashboard();
                    } else {
                        loadStudents();
                    }
                } else {
                    const error = await response.json();
                    errorDiv.textContent = error.error || 'Login failed';
                    errorDiv.style.display = 'block';
                }
            } catch (error) {
                errorDiv.textContent = 'Network error. Please try again.';
                errorDiv.style.display = 'block';
            }
        }

        function switchLoginTab(type) {
            const staffTab = document.getElementById('staffTab');
            const studentTab = document.getElementById('studentTab');
            const staffFields = document.getElementById('staffLoginFields');
            const studentFields = document.getElementById('studentLoginFields');
            
            if (type === 'staff') {
                staffTab.classList.add('active');
                studentTab.classList.remove('active');
                staffFields.style.display = 'block';
                studentFields.style.display = 'none';
            } else {
                studentTab.classList.add('active');
                staffTab.classList.remove('active');
                staffFields.style.display = 'none';
                studentFields.style.display = 'block';
            }
        }

        function toggleLoginForm() {
            const loginType = document.getElementById('loginType').value;
            const staffFields = document.getElementById('staffLoginFields');
            const studentFields = document.getElementById('studentLoginFields');
            
            if (loginType === 'student') {
                staffFields.style.display = 'none';
                studentFields.style.display = 'block';
            } else {
                staffFields.style.display = 'block';
                studentFields.style.display = 'none';
            }
        }

        async function logout() {
            try {
                await fetch('/api/logout', { method: 'POST' });
                currentUser = null;
                showLogin();
            } catch (error) {
                console.error('Error logging out:', error);
            }
        }

        function showLogin() {
            document.getElementById('loginForm').style.display = 'flex';
            document.getElementById('appContainer').style.display = 'none';
        }

        function showApp() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('appContainer').style.display = 'flex';
            updateUserInfo();
            
            // Show role-specific navigation
            if (currentUser && currentUser.role === 'teacher') {
                // Show staff navigation
                document.getElementById('activeStudentsNav').style.display = 'block';
                document.getElementById('dataLogNav').style.display = 'block';
                document.getElementById('teacherDashboardNav').style.display = 'block';
                document.getElementById('teacherManagementNav').style.display = 'none';
                // Hide student navigation
                document.getElementById('studentAttendanceNav').style.display = 'none';
                document.getElementById('studentGradesNav').style.display = 'none';
                showActiveStudents();
            } else if (currentUser && currentUser.role === 'principal') {
                // Show staff navigation
                document.getElementById('activeStudentsNav').style.display = 'block';
                document.getElementById('dataLogNav').style.display = 'block';
                document.getElementById('teacherManagementNav').style.display = 'block';
                document.getElementById('teacherDashboardNav').style.display = 'none';
                // Hide student navigation
                document.getElementById('studentAttendanceNav').style.display = 'none';
                document.getElementById('studentGradesNav').style.display = 'none';
                showActiveStudents();
            } else if (currentUser && currentUser.role === 'student') {
                // Hide staff navigation
                document.getElementById('activeStudentsNav').style.display = 'none';
                document.getElementById('dataLogNav').style.display = 'none';
                document.getElementById('teacherDashboardNav').style.display = 'none';
                document.getElementById('teacherManagementNav').style.display = 'none';
                // Show student navigation
                document.getElementById('studentAttendanceNav').style.display = 'block';
                document.getElementById('studentGradesNav').style.display = 'block';
                showStudentDashboard();
            }
        }

        function updateUserInfo() {
            if (currentUser) {
                document.getElementById('userName').textContent = currentUser.username;
                document.getElementById('userRole').textContent = currentUser.role;
                document.getElementById('userInitial').textContent = currentUser.username.charAt(0).toUpperCase();
            }
        }

        function showActiveStudents() {
            hideAllPages();
            document.getElementById('activeStudentsPage').style.display = 'block';
            updateNavigation('active');
            loadStudents();
        }

        function showDataLog() {
            console.log('showDataLog called');
            hideAllPages();
            const dataLogPage = document.getElementById('dataLogPage');
            console.log('dataLogPage element:', dataLogPage);
            dataLogPage.style.display = 'block';
            console.log('dataLogPage display style:', dataLogPage.style.display);
            updateNavigation('log');
            loadLog();
        }

        function updateNavigation(activePage) {
            // Remove active class from all nav links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            // Add active class to current page
            if (activePage === 'active') {
                document.querySelector('.nav-link').classList.add('active');
            } else if (activePage === 'log') {
                document.querySelectorAll('.nav-link')[1].classList.add('active');
            } else if (activePage === 'teachers') {
                document.querySelectorAll('.nav-link')[2].classList.add('active');
            } else if (activePage === 'teacher-dashboard') {
                // Find the teacher dashboard nav link and make it active
                const teacherDashboardLink = document.querySelector('.nav-link[onclick="showTeacherDashboard()"]');
                if (teacherDashboardLink) {
                    teacherDashboardLink.classList.add('active');
                }
            }
        }

        function hideAllPages() {
            document.getElementById('activeStudentsPage').style.display = 'none';
            document.getElementById('dataLogPage').style.display = 'none';
            document.getElementById('teacherManagementPage').style.display = 'none';
            document.getElementById('teacherDashboardPage').style.display = 'none';
        }

        async function showAddStudentForm() {
            // Remove any existing modal first
            const existingModal = document.getElementById('addStudentModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            try {
                const response = await fetch('/api/classes');
                const classes = await response.json();
                
                const classOptions = classes.map(cls => `<option value="${cls}">${cls}</option>`).join('');
                
                // Create a compact modal for adding students
                const form = `
                    <div id="addStudentModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;">
                        <div style="background: white; padding: 25px; border-radius: 12px; width: 350px; max-height: 90vh; overflow-y: auto;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h3 style="margin: 0; color: #374151; font-size: 18px;">➕ Add New Student</h3>
                                <button onclick="closeAddStudentForm()" style="background: none; border: none; font-size: 20px; cursor: pointer; color: #666;">×</button>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <!-- Name (full width) -->
                                <div style="grid-column: 1 / -1;">
                                    <label for="studentName" style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151; font-size: 14px;">👤 Student Name *</label>
                                    <input type="text" id="studentName" name="studentName" autocomplete="off" placeholder="Enter full name" style="width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                                </div>
                                
                                <!-- Age and Class -->
                                <div>
                                    <label for="studentAge" style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151; font-size: 14px;">🎂 Age *</label>
                                    <input type="number" id="studentAge" name="studentAge" autocomplete="off" placeholder="Age" min="3" max="25" style="width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                                </div>
                                
                                <div>
                                    <label for="studentClass" style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151; font-size: 14px;">📚 Class *</label>
                                    <select id="studentClass" name="studentClass" autocomplete="off" style="width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                                        <option value="">Select class</option>
                                        ${classOptions}
                                    </select>
                                </div>
                                
                                <!-- Roll Number and Password -->
                                <div>
                                    <label for="studentRoll" style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151; font-size: 14px;">🔢 Roll Number *</label>
                                    <input type="number" id="studentRoll" name="studentRoll" autocomplete="off" placeholder="Roll #" min="1" style="width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                                </div>
                                
                                <div>
                                    <label for="studentPass" style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151; font-size: 14px;">🔐 Password *</label>
                                    <input type="text" id="studentPass" name="studentPass" autocomplete="off" placeholder="Login password" oninput="this.setAttribute('data-has-value', 'true')" style="width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                                </div>
                            </div>
                            
                            <!-- Profile Picture Section -->
                            <div style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                                    <span style="font-weight: 600; color: #374151; font-size: 14px;">📸 Profile Picture</span>
                                    <span style="font-size: 12px; color: #666;">(Optional - helps with AI attendance)</span>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; align-items: start;">
                                    <!-- Camera/Upload Section -->
                                    <div>
                                        <div id="profilePicturePreview" style="width: 120px; height: 120px; border: 2px dashed #ddd; border-radius: 8px; display: flex; align-items: center; justify-content: center; background: #f8f9fa; margin-bottom: 10px; position: relative; overflow: hidden;">
                                            <div id="profilePicturePlaceholder" style="text-align: center; color: #666; font-size: 12px;">
                                                <div style="font-size: 24px; margin-bottom: 5px;">📷</div>
                                                No photo
                                            </div>
                                            <img id="profilePictureImage" src="" alt="Profile Picture" style="width: 100%; height: 100%; object-fit: cover; display: none;">
                                        </div>
                                        
                                        <div style="display: flex; gap: 8px;">
                                            <button type="button" onclick="openCamera()" style="flex: 1; padding: 8px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 600;">📷 Camera</button>
                                            <button type="button" onclick="document.getElementById('profilePictureFile').click()" style="flex: 1; padding: 8px; background: #95a5a6; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 600;">📁 Upload</button>
                                            <button type="button" onclick="clearProfilePicture()" style="flex: 1; padding: 8px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 600;">🗑️ Clear</button>
                                        </div>
                                        
                                        <input type="file" id="profilePictureFile" accept="image/*" style="display: none;" onchange="handleProfilePictureUpload(event)">
                                    </div>
                                    
                                    <!-- Camera Modal -->
                                    <div id="cameraModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: flex; align-items: center; justify-content: center;">
                                        <div style="background: white; padding: 20px; border-radius: 10px; width: 400px; max-width: 90vw;">
                                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                                <h4 style="margin: 0; color: #374151;">📷 Take Profile Picture</h4>
                                                <button onclick="closeCamera()" style="background: none; border: none; font-size: 20px; cursor: pointer; color: #666;">×</button>
                                            </div>
                                            
                                            <video id="cameraVideo" style="width: 100%; border-radius: 8px; margin-bottom: 15px;" autoplay></video>
                                            
                                            <div style="display: flex; gap: 10px;">
                                                <button onclick="captureProfilePicture()" style="flex: 1; padding: 10px; background: #27ae60; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">📸 Capture</button>
                                                <button onclick="closeCamera()" style="flex: 1; padding: 10px; background: #95a5a6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">❌ Cancel</button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Info Section -->
                                    <div style="font-size: 12px; color: #666; line-height: 1.4;">
                                        <div style="margin-bottom: 8px;">
                                            <strong>💡 Why add a profile picture?</strong>
                                        </div>
                                        <ul style="margin: 0; padding-left: 15px;">
                                            <li>Enables AI-powered automatic attendance</li>
                                            <li>Faster attendance verification</li>
                                            <li>Reduces manual work for teachers</li>
                                            <li>Can be added later if needed</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Optional Marks Section (Collapsible) -->
                            <div style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px;">
                                <button type="button" onclick="toggleMarksSection()" id="toggleMarksBtn" style="background: none; border: none; color: #3498db; cursor: pointer; font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 5px;">
                                    <span id="toggleMarksIcon">▶</span>
                                    📊 Add Marks (Optional)
                                </button>
                                
                                <div id="marksSection" style="display: none; margin-top: 15px;">
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                        <div>
                                            <label for="studentMath" style="display: block; margin-bottom: 3px; font-weight: 500; color: #666; font-size: 12px;">Math</label>
                                            <input type="number" id="studentMath" name="studentMath" placeholder="0-100" min="0" max="100" style="width: 100%; padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                                        </div>
                                        <div>
                                            <label for="studentScience" style="display: block; margin-bottom: 3px; font-weight: 500; color: #666; font-size: 12px;">Science</label>
                                            <input type="number" id="studentScience" name="studentScience" placeholder="0-100" min="0" max="100" style="width: 100%; padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                                        </div>
                                        <div>
                                            <label for="studentHistory" style="display: block; margin-bottom: 3px; font-weight: 500; color: #666; font-size: 12px;">History</label>
                                            <input type="number" id="studentHistory" name="studentHistory" placeholder="0-100" min="0" max="100" style="width: 100%; padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                                        </div>
                                        <div>
                                            <label for="studentEnglish" style="display: block; margin-bottom: 3px; font-weight: 500; color: #666; font-size: 12px;">English</label>
                                            <input type="number" id="studentEnglish" name="studentEnglish" placeholder="0-100" min="0" max="100" style="width: 100%; padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Action Buttons -->
                            <div style="display: flex; gap: 10px; margin-top: 25px;">
                                <button onclick="addStudent()" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px;">✅ Add Student</button>
                                <button onclick="closeAddStudentForm()" style="flex: 1; padding: 12px; background: #f8f9fa; color: #666; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px;">❌ Cancel</button>
                            </div>
                            
                            <div style="margin-top: 10px; font-size: 12px; color: #666; text-align: center;">
                                * Required fields • Marks can be added later
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', form);
            } catch (error) {
                console.error('Error loading classes:', error);
                alert('Error loading available classes');
            }
        }

        function closeAddStudentForm() {
            const modal = document.getElementById('addStudentModal');
            if (modal) {
                modal.remove();
            }
        }

        function toggleMarksSection() {
            const marksSection = document.getElementById('marksSection');
            const toggleIcon = document.getElementById('toggleMarksIcon');
            const toggleBtn = document.getElementById('toggleMarksBtn');
            
            if (marksSection.style.display === 'none') {
                marksSection.style.display = 'block';
                toggleIcon.textContent = '▼';
                toggleBtn.style.color = '#2c3e50';
            } else {
                marksSection.style.display = 'none';
                toggleIcon.textContent = '▶';
                toggleBtn.style.color = '#3498db';
            }
        }

        // Profile Picture Functions
        let profilePictureData = null;
        let cameraStream = null;

        function openCamera() {
            const modal = document.getElementById('cameraModal');
            const video = document.getElementById('cameraVideo');
            
            modal.style.display = 'flex';
            
            navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } })
                .then(stream => {
                    cameraStream = stream;
                    video.srcObject = stream;
                })
                .catch(err => {
                    console.error('Error accessing camera:', err);
                    alert('Could not access camera. Please use file upload instead.');
                    closeCamera();
                });
        }

        function closeCamera() {
            const modal = document.getElementById('cameraModal');
            modal.style.display = 'none';
            
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
        }

        function captureProfilePicture() {
            const video = document.getElementById('cameraVideo');
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0);
            
            const imageData = canvas.toDataURL('image/jpeg', 0.8);
            setProfilePicture(imageData);
            
            closeCamera();
        }

        function handleProfilePictureUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    setProfilePicture(e.target.result);
                };
                reader.readAsDataURL(file);
            }
        }

        function setProfilePicture(imageData) {
            profilePictureData = imageData;
            
            const placeholder = document.getElementById('profilePicturePlaceholder');
            const image = document.getElementById('profilePictureImage');
            
            placeholder.style.display = 'none';
            image.src = imageData;
            image.style.display = 'block';
        }

        function clearProfilePicture() {
            profilePictureData = null;
            
            const placeholder = document.getElementById('profilePicturePlaceholder');
            const image = document.getElementById('profilePictureImage');
            
            placeholder.style.display = 'block';
            image.style.display = 'none';
            image.src = '';
            
            // Clear file input
            document.getElementById('profilePictureFile').value = '';
        }

        async function showProfilePicture(rollNumber, studentName) {
            try {
                const response = await fetch(`/api/student/profile-picture/${rollNumber}`);
                const data = await response.json();
                
                if (data.has_profile_picture && data.profile_picture) {
                    // Show profile picture in modal
                    const modal = `
                        <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 1000;">
                            <div style="background: white; padding: 20px; border-radius: 10px; text-align: center;">
                                <h3 style="margin: 0 0 15px 0; color: #374151;">📸 ${studentName}</h3>
                                <img src="${data.profile_picture}" alt="Profile Picture" style="max-width: 300px; max-height: 300px; border-radius: 8px; border: 2px solid #ddd;">
                                <div style="margin-top: 15px;">
                                    <button onclick="this.parentElement.parentElement.parentElement.remove()" style="padding: 8px 16px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer;">Close</button>
                                </div>
                            </div>
                        </div>
                    `;
                    document.body.insertAdjacentHTML('beforeend', modal);
                } else {
                    alert(`No profile picture available for ${studentName}.\nProfile pictures help enable AI-powered attendance verification.`);
                }
            } catch (error) {
                console.error('Error loading profile picture:', error);
                alert('Error loading profile picture');
            }
        }

        function addStudent() {
            // Debug: Check if elements exist
            const nameElement = document.getElementById('studentName');
            const ageElement = document.getElementById('studentAge');
            const classElement = document.getElementById('studentClass');
            const rollElement = document.getElementById('studentRoll');
            const passwordElement = document.getElementById('studentPass');
            
            console.log('Elements found:', {
                nameElement: !!nameElement,
                ageElement: !!ageElement,
                classElement: !!classElement,
                rollElement: !!rollElement,
                passwordElement: !!passwordElement
            });
            
            if (!nameElement || !ageElement || !classElement || !rollElement || !passwordElement) {
                alert('Form elements not found. Please refresh the page and try again.');
                return;
            }
            
            const name = nameElement.value.trim();
            const age = ageElement.value.trim();
            const className = classElement.value.trim();
            const roll = rollElement.value.trim();
            const password = passwordElement.value.trim();
            const mathMarks = document.getElementById('studentMath').value.trim();
            const scienceMarks = document.getElementById('studentScience').value.trim();
            const historyMarks = document.getElementById('studentHistory').value.trim();
            const englishMarks = document.getElementById('studentEnglish').value.trim();
            
            // Check if password field has been filled (using data attribute as backup)
            const passwordFilled = password.length > 0 || passwordElement.hasAttribute('data-has-value');
            
            console.log('Form values:', { name, age, className, roll, password, mathMarks, scienceMarks, historyMarks, englishMarks });
            console.log('Password field details:', {
                passwordValue: password,
                passwordLength: password.length,
                hasDataAttribute: passwordElement.hasAttribute('data-has-value'),
                passwordFilled: passwordFilled
            });
            console.log('Validation check:', { name: !!name, age: !!age, className: !!className, roll: !!roll, password: passwordFilled });
            
            if (!name || !age || !className || !roll || !passwordFilled) {
                alert('Please fill in all required fields (Name, Age, Class, Roll Number, and Password)');
                return;
            }
            
            const student = {
                name: name,
                age: parseInt(age),
                class: className,
                roll: parseInt(roll),
                password: password,
                profile_picture: profilePictureData, // Include profile picture if available
                marks: {
                    math: mathMarks ? parseInt(mathMarks) : null,
                    science: scienceMarks ? parseInt(scienceMarks) : null,
                    history: historyMarks ? parseInt(historyMarks) : null,
                    english: englishMarks ? parseInt(englishMarks) : null
                },
                addedBy: currentUser.username,
                timestamp: new Date().toISOString()
            };
            
            // Send to backend
            fetch('/api/students', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(student)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    closeAddStudentForm();
                    loadStudents();
                    
                    // Show success message with profile picture info
                    let message = '✅ Student added successfully!';
                    if (data.has_profile_picture) {
                        message += '\n📸 Profile picture uploaded - AI attendance enabled!';
                    } else {
                        message += '\n💡 Profile picture can be added later for AI attendance.';
                    }
                    alert(message);
                } else {
                    alert('Error adding student: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error adding student');
            });
        }

        async function loadStudents() {
            try {
                // Add timestamp to prevent caching
                const timestamp = new Date().getTime();
                const response = await fetch(`/api/students?t=${timestamp}`);
                if (response.ok) {
                    students = await response.json(); // Store students globally
                    displayStudents(students);
                }
            } catch (error) {
                console.error('Error loading students:', error);
            }
        }

        function displayStudents(students) {
            const tableDiv = document.getElementById('studentsTable');
            if (students.length === 0) {
                tableDiv.innerHTML = '<p>No students found.</p>';
                return;
            }

            let html = `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Age</th>
                                <th>Class</th>
                                <th>Roll Number</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            students.forEach((student, index) => {
                html += `
                    <tr>
                        <td>
                            <span onclick="showProfilePicture(${student.roll}, '${student.name}')" 
                                  style="cursor: pointer; color: #333; font-weight: 500;"
                                  title="Click to view profile picture">
                                ${student.name}
                            </span>
                        </td>
                        <td>${student.age}</td>
                        <td>${student.class}</td>
                        <td>${student.roll}</td>
                        <td>
                            <button onclick="showStudentDetails(${index})" class="btn btn-primary">View Details</button>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table></div>';
            tableDiv.innerHTML = html;
        }

        async function loadLog() {
            try {
                console.log('loadLog called');
                // Add timestamp to prevent caching
                const timestamp = new Date().getTime();
                const response = await fetch(`/api/log?t=${timestamp}`);
                console.log('log response status:', response.status);
                if (response.ok) {
                    const log = await response.json();
                    console.log('log data received:', log);
                    displayLog(log);
                } else {
                    console.error('Log response not ok:', response.status);
                }
            } catch (error) {
                console.error('Error loading log:', error);
            }
        }

        function displayLog(log) {
            const tableDiv = document.getElementById('logTable');
            console.log('displayLog called with log:', log);
            console.log('log length:', log.length);
            
            let html = '';
            if (log.length === 0) {
                html = '<p>No log entries found.</p>';
            } else {
                html = `
                    <div class="table-container">
                        <table>
                                                    <thead>
                            <tr>
                                <th style="min-width: 250px; width: 250px;">Action</th>
                                <th>Details</th>
                                <th>Timestamp</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                            <tbody>
                `;

                log.forEach((entry, index) => {
                    // Determine action text and color
                    let actionText = '';
                    let actionClass = '';
                    let studentDetails = '';
                    
                    // Format action text
                    switch(entry.action) {
                        case 'add':
                            actionText = 'STUDENT ADDED';
                            actionClass = 'data-log-row-add';
                            break;
                        case 'edit':
                            actionText = 'STUDENT EDITED';
                            actionClass = 'data-log-row-edit';
                            break;
                        case 'delete':
                            actionText = 'STUDENT DELETED';
                            actionClass = 'data-log-row-delete';
                            break;
                        case 'recover':
                            actionText = 'STUDENT RECOVERED';
                            actionClass = 'data-log-row-recover';
                            break;
                        case 'permadelete':
                            actionText = 'STUDENT PERMANENTLY DELETED';
                            actionClass = 'data-log-row-permadelete';
                            break;
                        case 'clear':
                            actionText = 'ALL DATA CLEARED';
                            actionClass = 'data-log-row-clear';
                            break;
                        case 'recoverall':
                            actionText = 'ALL DATA RECOVERED';
                            actionClass = 'data-log-row-recoverall';
                            break;
                        case 'add_teacher':
                            actionText = 'TEACHER ADDED';
                            actionClass = 'data-log-row-add';
                            break;
                        case 'change_teacher_password':
                            actionText = 'PASSWORD CHANGED';
                            actionClass = 'data-log-row-edit';
                            break;
                        case 'delete_teacher':
                            actionText = 'TEACHER DELETED';
                            actionClass = 'data-log-row-delete';
                            break;
                        case 'undo_edit':
                            actionText = 'EDIT UNDONE';
                            actionClass = 'data-log-row-recover';
                            break;
                        case 'update_marks':
                            actionText = 'MARKS UPDATED';
                            actionClass = 'data-log-row-edit';
                            break;
                        default:
                            actionText = entry.action.toUpperCase();
                            actionClass = 'data-log-row-default';
                    }

                    // Format details based on action type
                    if (entry.student) {
                        studentDetails = `${entry.student.name} (Age: ${entry.student.age}, Class: ${entry.student.class}, Roll: ${entry.student.roll})`;
                    } else if (entry.action === 'change_teacher_password') {
                        studentDetails = `Teacher: ${entry.teacher_username}`;
                    } else if (entry.action === 'add_teacher') {
                        studentDetails = `Teacher: ${entry.teacher ? entry.teacher.username : 'Unknown'}`;
                    } else if (entry.action === 'delete_teacher') {
                        studentDetails = `Teacher: ${entry.teacher ? entry.teacher.username : 'Unknown'}`;
                    } else if (entry.action === 'update_marks') {
                        studentDetails = `Student: ${entry.student ? entry.student.name : 'Unknown'}`;
                    } else if (entry.action === 'clear') {
                        studentDetails = 'All students and deleted students cleared';
                    } else if (entry.action === 'recoverall') {
                        studentDetails = 'All previously cleared data recovered';
                    } else {
                        studentDetails = 'N/A';
                    }

                    // Format timestamp
                    const timestamp = entry.when || 'Unknown';
                    
                    // Generate details button
                    let detailsButton = `<button onclick="showLogDetails(${index})" class="btn btn-primary">View Details</button>`;

                    html += `
                        <tr style="border-bottom: 1px solid #eee;" class="${actionClass}">
                            <td style="padding: 8px 30px; min-width: 250px; width: 250px;">
                                <span style="
                                    padding: 6px 12px; 
                                    border-radius: 6px; 
                                    font-size: 11px; 
                                    font-weight: bold;
                                    text-transform: uppercase;
                                    letter-spacing: 0.5px;
                                    color: white;
                                    ${entry.action === 'add' || entry.action === 'add_teacher' ? 'background-color: #4CAF50;' : ''}
                                    ${entry.action === 'delete' || entry.action === 'delete_teacher' ? 'background-color: #f44336;' : ''}
                                    ${entry.action === 'edit' || entry.action === 'change_teacher_password' || entry.action === 'update_marks' ? 'background-color: #FF9800;' : ''}
                                    ${entry.action === 'recover' || entry.action === 'undo_edit' ? 'background-color: #2196F3;' : ''}
                                    ${entry.action === 'permadelete' ? 'background-color: #9C27B0;' : ''}
                                    ${entry.action === 'clear' ? 'background-color: #FF5722;' : ''}
                                    ${entry.action === 'recoverall' ? 'background-color: #00BCD4;' : ''}
                                    ${!['add', 'delete', 'edit', 'recover', 'permadelete', 'clear', 'recoverall', 'add_teacher', 'delete_teacher', 'change_teacher_password', 'undo_edit', 'update_marks'].includes(entry.action) ? 'background-color: #6b7280;' : ''}
                                ">
                                    ${actionText}
                                </span>
                            </td>
                            <td>${studentDetails}</td>
                            <td>${timestamp}</td>
                            <td>${detailsButton}</td>
                        </tr>
                    `;
                });

                html += '</tbody></table></div>';
            }
            
            // Add clear log information underneath if it exists (always check, even for empty logs)
            fetch('/api/clear_log')
            .then(response => response.json())
            .then(clearInfo => {
                if (clearInfo && clearInfo.clearedBy && clearInfo.clearedAt) {
                    const clearDate = new Date(clearInfo.clearedAt).toLocaleDateString();
                    const clearTime = new Date(clearInfo.clearedAt).toLocaleTimeString();
                    html += `<p style="text-align: center; margin-top: 20px; color: #666; font-size: 14px;">Data Log last cleared by ${clearInfo.clearedBy} on ${clearDate} at ${clearTime}</p>`;
                } else {
                    // Try localStorage fallback
                    const localClear = localStorage.getItem('clearLogInfo');
                    if (localClear) {
                        const info = JSON.parse(localClear);
                        const clearDate = new Date(info.clearedAt).toLocaleDateString();
                        const clearTime = new Date(info.clearedAt).toLocaleTimeString();
                        html += `<p style="text-align: center; margin-top: 20px; color: #666; font-size: 14px;">Data Log last cleared by ${info.clearedBy} on ${clearDate} at ${clearTime}</p>`;
                    }
                }
                tableDiv.innerHTML = html;
            })
            .catch(error => {
                console.error('Error loading clear log info:', error);
                tableDiv.innerHTML = html;
            });
        }

        function recoverStudentFromLog(logIndex) {
            if (confirm('Are you sure you want to recover this student?')) {
                fetch(`/api/deleted_students/${logIndex}/recover`, {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Student recovered successfully!');
                        loadLog(); // Refresh the log to show the recovery action
                    } else {
                        alert('Error recovering student: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error recovering student');
                });
            }
        }

        function undoAddStudent(logIndex) {
            if (confirm('Are you sure you want to delete this student? This will undo the add action.')) {
                // Find the student in the active students list and delete them
                fetch('/api/students')
                .then(response => response.json())
                .then(students => {
                    if (students.length > 0) {
                        // Delete the most recently added student (assuming log index corresponds to student index)
                        const studentToDelete = students[students.length - 1];
                        const studentIndex = students.length - 1;
                        
                        fetch(`/api/students/${studentIndex}`, {
                            method: 'DELETE'
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                alert('Student deleted successfully!');
                                loadLog();
                                loadStudents();
                            } else {
                                alert('Error deleting student: ' + data.error);
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('Error deleting student');
                        });
                    } else {
                        alert('No students found to delete.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error loading students');
                });
            }
        }

        function undoRecoverStudent(logIndex) {
            if (confirm('Are you sure you want to delete this student? This will undo the recover action.')) {
                // Find the most recently recovered student and delete them
                fetch('/api/students')
                .then(response => response.json())
                .then(students => {
                    if (students.length > 0) {
                        const studentIndex = students.length - 1;
                        
                        fetch(`/api/students/${studentIndex}`, {
                            method: 'DELETE'
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                alert('Student deleted successfully!');
                                loadLog();
                                loadStudents();
                            } else {
                                alert('Error deleting student: ' + data.error);
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('Error deleting student');
                        });
                    } else {
                        alert('No students found to delete.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error loading students');
                });
            }
        }

        function recoverAllData() {
            if (confirm('Are you sure you want to recover all data? This will undo the clear action.')) {
                fetch('/api/recover_all', {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('All data recovered successfully!');
                        loadLog();
                        loadStudents();
                    } else {
                        alert('Error recovering data: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error recovering data');
                });
            }
        }

        function clearAllData() {
            if (confirm('Are you sure you want to clear all data? This will undo the recover all action.')) {
                fetch('/api/clear_all', {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('All data cleared successfully!');
                        loadLog();
                        loadStudents();
                    } else {
                        alert('Error clearing data: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error clearing data');
                });
            }
        }

        function showStudentDetails(index) {
            if (index < 0 || index >= students.length) {
                alert('Student not found');
                return;
            }
            
            const student = students[index];
            const currentUserRole = currentUser ? currentUser.role : 'teacher';
            const whoAdded = student.addedBy || 'Unknown';
            
            // Check permissions
            let editDisabled = '';
            let deleteDisabled = '';
            let editClass = '';
            let deleteClass = '';
            let editTitle = '';
            let deleteTitle = '';
            
            // Teachers cannot edit/delete students added by principals
            if (currentUserRole === 'teacher' && whoAdded === 'principal') {
                editDisabled = 'disabled';
                deleteDisabled = 'disabled';
                editClass = 'edit-btn-disabled';
                deleteClass = 'delete-btn-disabled';
                editTitle = 'Only the principal can edit this student.';
                deleteTitle = 'Only the principal can delete this student.';
            }
            
            const modalOverlay = document.createElement('div');
            modalOverlay.className = 'modal-overlay';
            modalOverlay.innerHTML = `
                <div class="modal-content">
                    <button class="modal-close" onclick="closeStudentDetails()">&times;</button>
                    <h2>Student Details</h2>
                    <div class="modal-section">
                        <label class="modal-label">Name:</label>
                        <span class="modal-value">${student.name}</span>
                    </div>
                    <div class="modal-section">
                        <label class="modal-label">Age:</label>
                        <span class="modal-value">${student.age}</span>
                    </div>
                    <div class="modal-section">
                        <label class="modal-label">Class:</label>
                        <span class="modal-value">${student.class}</span>
                    </div>
                    <div class="modal-section">
                        <label class="modal-label">Roll Number:</label>
                        <span class="modal-value">${student.roll}</span>
                    </div>
                    <div class="modal-section">
                        <label class="modal-label">Marks & Grades:</label>
                        <span class="modal-value">
                            <div style="margin: 5px 0;">
                                <strong>Math:</strong> ${student.marks.math || 'N/A'} marks (Grade: ${student.marks.math ? calculateGrade(student.marks.math) : 'N/A'})
                            </div>
                            <div style="margin: 5px 0;">
                                <strong>Science:</strong> ${student.marks.science || 'N/A'} marks (Grade: ${student.marks.science ? calculateGrade(student.marks.science) : 'N/A'})
                            </div>
                            <div style="margin: 5px 0;">
                                <strong>History:</strong> ${student.marks.history || 'N/A'} marks (Grade: ${student.marks.history ? calculateGrade(student.marks.history) : 'N/A'})
                            </div>
                            <div style="margin: 5px 0;">
                                <strong>English:</strong> ${student.marks.english || 'N/A'} marks (Grade: ${student.marks.english ? calculateGrade(student.marks.english) : 'N/A'})
                            </div>
                        </span>
                    </div>
                    <div class="modal-section">
                        <label class="modal-label">Added By:</label>
                        <span class="modal-value">${student.addedBy}</span>
                    </div>
                    <div class="modal-section">
                        <label class="modal-label">Timestamp:</label>
                        <span class="modal-value">${student.timestamp}</span>
                    </div>
                    <div class="modal-actions">
                        <button onclick="${editDisabled ? '' : `editStudent(${index})`}" class="edit-btn ${editClass}" ${editDisabled} title="${editTitle}">Edit</button>
                        <button onclick="${deleteDisabled ? '' : `deleteStudent(${index})`}" class="delete-btn ${deleteClass}" ${deleteDisabled} title="${deleteTitle}">Delete</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modalOverlay);
        }

        function closeStudentDetails() {
            const modalOverlay = document.querySelector('.modal-overlay');
            if (modalOverlay) {
                modalOverlay.remove();
            }
        }

        function editStudent(index) {
            if (index < 0 || index >= students.length) {
                alert('Student not found');
                return;
            }
            
            // Close any existing edit modal first
            closeEditStudentForm();
            
            const student = students[index];
            const name = student.name;
            const age = student.age;
            const className = student.class;
            const roll = student.roll;
            const mathMarks = student.marks.math;
            const scienceMarks = student.marks.science;
            const historyMarks = student.marks.history;
            const englishMarks = student.marks.english;
            
            const form = `
                <div class="modal-overlay">
                    <div class="modal-content">
                        <button class="modal-close" onclick="closeEditStudentForm()">&times;</button>
                        <h2>Edit Student</h2>
                        <div class="modal-section">
                            <label class="modal-label">Name:</label>
                            <input type="text" id="editStudentName" value="${name}" style="width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ccc; border-radius: 5px;">
                        </div>
                        <div class="modal-section">
                            <label class="modal-label">Age:</label>
                            <input type="number" id="editStudentAge" value="${age}" style="width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ccc; border-radius: 5px;">
                        </div>
                        <div class="modal-section">
                            <label class="modal-label">Class:</label>
                            <input type="text" id="editStudentClass" value="${className}" style="width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ccc; border-radius: 5px;">
                        </div>
                        <div class="modal-section">
                            <label class="modal-label">Roll Number:</label>
                            <input type="number" id="editStudentRoll" value="${roll}" style="width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ccc; border-radius: 5px;">
                        </div>
                        <div class="modal-section">
                            <label class="modal-label">Subject Marks:</label>
                        </div>
                        <div class="modal-section">
                            <input type="number" id="editStudentMath" value="${mathMarks}" min="0" max="100" style="width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ccc; border-radius: 5px;">
                        </div>
                        <div class="modal-section">
                            <input type="number" id="editStudentScience" value="${scienceMarks}" min="0" max="100" style="width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ccc; border-radius: 5px;">
                        </div>
                        <div class="modal-section">
                            <input type="number" id="editStudentHistory" value="${historyMarks}" min="0" max="100" style="width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ccc; border-radius: 5px;">
                        </div>
                        <div class="modal-section">
                            <input type="number" id="editStudentEnglish" value="${englishMarks}" min="0" max="100" style="width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ccc; border-radius: 5px;">
                        </div>
                        <div class="modal-actions">
                            <button class="edit-btn" onclick="saveEditedStudent(${index})">Save Changes</button>
                            <button class="delete-btn" onclick="deleteStudent(${index})">Delete</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', form);
        }

        function closeEditStudentForm() {
            const modalOverlay = document.querySelector('.modal-overlay');
            if (modalOverlay) {
                modalOverlay.remove();
            }
        }

        function saveEditedStudent(index) {
            const name = document.getElementById('editStudentName').value;
            const age = document.getElementById('editStudentAge').value;
            const className = document.getElementById('editStudentClass').value;
            const roll = document.getElementById('editStudentRoll').value;
            const mathMarks = document.getElementById('editStudentMath').value;
            const scienceMarks = document.getElementById('editStudentScience').value;
            const historyMarks = document.getElementById('editStudentHistory').value;
            const englishMarks = document.getElementById('editStudentEnglish').value;
            
            if (!name || !age || !className || !roll || !mathMarks || !scienceMarks || !historyMarks || !englishMarks) {
                alert('Please fill in all fields');
                return;
            }

            const updatedStudent = {
                name: name,
                age: parseInt(age),
                class: className,
                roll: parseInt(roll),
                marks: {
                    math: parseInt(mathMarks),
                    science: parseInt(scienceMarks),
                    history: parseInt(historyMarks),
                    english: parseInt(englishMarks)
                }
            };

            console.log(`Sending edit request for student ${index}:`, updatedStudent);
            fetch(`/api/students/${index}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(updatedStudent)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    closeEditStudentForm();
                    loadStudents();
                } else {
                    alert('Error updating student: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error updating student');
            });
        }

        function deleteStudent(index) {
            if (confirm('Are you sure you want to delete this student? This action cannot be undone.')) {
                fetch(`/api/students/${index}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        closeStudentDetails(); // Close the details modal
                        loadStudents();
                    } else {
                        alert('Error deleting student: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error deleting student');
                });
            }
        }

        function clearDataLog() {
            if (confirm('Are you sure you want to clear all data log entries? This action cannot be undone.')) {
                fetch('/api/clear_log', {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Store clear info in localStorage
                        const now = new Date();
                        const clearInfo = {
                            clearedBy: currentUser ? currentUser.role : 'principal',
                            clearedAt: now.toISOString()
                        };
                        localStorage.setItem('clearLogInfo', JSON.stringify(clearInfo));
                        alert('Data log cleared successfully!');
                        loadLog();
                    } else {
                        alert('Error clearing data log: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error clearing data log', error);
                    alert('Error clearing data log');
                });
            }
        }

        function undoEditStudent(logIndex) {
            if (confirm('Are you sure you want to undo this edit? This will revert the student to their previous information.')) {
                fetch(`/api/undo_edit/${logIndex}`, {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Edit undone successfully!');
                        loadLog();
                        loadStudents();
                    } else {
                        alert('Error undoing edit: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error undoing edit');
                });
            }
        }

        function showEditDetails(logIndex) {
            console.log('showEditDetails called with index:', logIndex);
            // Fetch the log data to get the specific entry
            fetch('/api/log')
            .then(response => response.json())
            .then(log => {
                console.log('Fetched log data:', log);
                console.log('Log entry at index', logIndex, ':', log[logIndex]);
                
                if (logIndex < 0 || logIndex >= log.length) {
                    alert('Log entry not found');
                    return;
                }
                
                const logEntry = log[logIndex];
                if (logEntry.action !== 'edit') {
                    alert('This is not an edit action');
                    return;
                }
                
                console.log('Log entry is edit action:', logEntry);
                const currentStudent = logEntry.student;
                const originalStudent = logEntry.original_student;
                
                console.log('Current student:', currentStudent);
                console.log('Original student:', originalStudent);
                
                const modalOverlay = document.createElement('div');
                modalOverlay.className = 'modal-overlay';
                modalOverlay.innerHTML = `
                    <div class="modal-content">
                        <button class="modal-close" onclick="closeEditDetails()">&times;</button>
                        <h2>Edit Details</h2>
                        <div class="modal-section">
                            <label class="modal-label">Student:</label>
                            <span class="modal-value">${currentStudent.name} (Roll: ${currentStudent.roll})</span>
                        </div>
                        <div class="modal-section">
                            <label class="modal-label">Edited By:</label>
                            <span class="modal-value">${logEntry.who}</span>
                        </div>
                        <div class="modal-section">
                            <label class="modal-label">Timestamp:</label>
                            <span class="modal-value">${logEntry.when}</span>
                        </div>
                        <div style="display: flex; gap: 20px; margin-top: 20px;">
                            <div style="flex: 1;">
                                <h3 style="color: #f44336; margin-bottom: 10px;">Before Edit</h3>
                                <div class="modal-section">
                                    <label class="modal-label">Name:</label>
                                    <span class="modal-value">${originalStudent.name}</span>
                                </div>
                                <div class="modal-section">
                                    <label class="modal-label">Age:</label>
                                    <span class="modal-value">${originalStudent.age}</span>
                                </div>
                                <div class="modal-section">
                                    <label class="modal-label">Class:</label>
                                    <span class="modal-value">${originalStudent.class}</span>
                                </div>
                                <div class="modal-section">
                                    <label class="modal-label">Roll Number:</label>
                                    <span class="modal-value">${originalStudent.roll}</span>
                                </div>
                                <div class="modal-section">
                                    <label class="modal-label">Marks & Grades:</label>
                                    <span class="modal-value">
                                        <div style="margin: 5px 0;">
                                            <strong>Math:</strong> ${originalStudent.marks.math || 'N/A'} marks (Grade: ${originalStudent.marks.math ? calculateGrade(originalStudent.marks.math) : 'N/A'})
                                        </div>
                                        <div style="margin: 5px 0;">
                                            <strong>Science:</strong> ${originalStudent.marks.science || 'N/A'} marks (Grade: ${originalStudent.marks.science ? calculateGrade(originalStudent.marks.science) : 'N/A'})
                                        </div>
                                        <div style="margin: 5px 0;">
                                            <strong>History:</strong> ${originalStudent.marks.history || 'N/A'} marks (Grade: ${originalStudent.marks.history ? calculateGrade(originalStudent.marks.history) : 'N/A'})
                                        </div>
                                        <div style="margin: 5px 0;">
                                            <strong>English:</strong> ${originalStudent.marks.english || 'N/A'} marks (Grade: ${originalStudent.marks.english ? calculateGrade(originalStudent.marks.english) : 'N/A'})
                                        </div>
                                    </span>
                                </div>
                            </div>
                            <div style="flex: 1;">
                                <h3 style="color: #4CAF50; margin-bottom: 10px;">After Edit</h3>
                                <div class="modal-section">
                                    <label class="modal-label">Name:</label>
                                    <span class="modal-value">${currentStudent.name}</span>
                                </div>
                                <div class="modal-section">
                                    <label class="modal-label">Age:</label>
                                    <span class="modal-value">${currentStudent.age}</span>
                                </div>
                                <div class="modal-section">
                                    <label class="modal-label">Class:</label>
                                    <span class="modal-value">${currentStudent.class}</span>
                                </div>
                                <div class="modal-section">
                                    <label class="modal-label">Roll Number:</label>
                                    <span class="modal-value">${currentStudent.roll}</span>
                                </div>
                                <div class="modal-section">
                                    <label class="modal-label">Marks & Grades:</label>
                                    <span class="modal-value">
                                        <div style="margin: 5px 0;">
                                            <strong>Math:</strong> ${currentStudent.marks.math || 'N/A'} marks (Grade: ${currentStudent.marks.math ? calculateGrade(currentStudent.marks.math) : 'N/A'})
                                        </div>
                                        <div style="margin: 5px 0;">
                                            <strong>Science:</strong> ${currentStudent.marks.science || 'N/A'} marks (Grade: ${currentStudent.marks.science ? calculateGrade(currentStudent.marks.science) : 'N/A'})
                                        </div>
                                        <div style="margin: 5px 0;">
                                            <strong>History:</strong> ${currentStudent.marks.history || 'N/A'} marks (Grade: ${currentStudent.marks.history ? calculateGrade(currentStudent.marks.history) : 'N/A'})
                                        </div>
                                        <div style="margin: 5px 0;">
                                            <strong>English:</strong> ${currentStudent.marks.english || 'N/A'} marks (Grade: ${currentStudent.marks.english ? calculateGrade(currentStudent.marks.english) : 'N/A'})
                                        </div>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modalOverlay);
                console.log('Modal created and added to DOM');
            })
            .catch(error => {
                console.error('Error fetching log data:', error);
                alert('Error loading edit details');
            });
        }

        function closeEditDetails() {
            const modalOverlay = document.querySelector('.modal-overlay');
            if (modalOverlay) {
                modalOverlay.remove();
            }
        }

        function showLogDetails(logIndex) {
            console.log('showLogDetails called with index:', logIndex);
            // Fetch the log data to get the specific entry
            fetch('/api/log')
            .then(response => response.json())
            .then(log => {
                console.log('Fetched log data:', log);
                console.log('Log entry at index', logIndex, ':', log[logIndex]);
                
                if (logIndex < 0 || logIndex >= log.length) {
                    alert('Log entry not found');
                    return;
                }
                
                const logEntry = log[logIndex];
                const student = logEntry.student;
                
                console.log('Log entry:', logEntry);
                console.log('Student:', student);
                
                // Build comprehensive details
                let historyHTML = '';
                let actionDetails = '';
                let undoButton = '';
                
                // Generate undo button based on action type and permissions
                const currentUserRole = currentUser ? currentUser.role : 'teacher';
                const whoPerformed = logEntry.who || 'Unknown';
                
                // Handle student actions
                if (['add', 'edit', 'delete', 'recover'].includes(logEntry.action)) {
                    switch(logEntry.action) {
                        case 'add':
                            if (currentUserRole === 'principal' || (currentUserRole === 'teacher' && whoPerformed === 'teacher')) {
                                undoButton = `<button onclick="undoAddStudent(${logIndex})" class="undo-btn" style="background-color: #f44336; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; margin-top: 10px;">Undo Add</button>`;
                            }
                            break;
                        case 'edit':
                            if (currentUserRole === 'principal' || (currentUserRole === 'teacher' && whoPerformed === 'teacher')) {
                                undoButton = `<button onclick="undoEditStudent(${logIndex})" class="undo-btn" style="background-color: #f44336; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; margin-top: 10px;">Undo Edit</button>`;
                            }
                            break;
                        case 'delete':
                            if (currentUserRole === 'principal' || (currentUserRole === 'teacher' && whoPerformed === 'teacher')) {
                                undoButton = `<button onclick="recoverStudentFromLog(${logIndex})" class="undo-btn" style="background-color: #4CAF50; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; margin-top: 10px;">Recover Student</button>`;
                            }
                            break;
                        case 'recover':
                            if (currentUserRole === 'principal' || (currentUserRole === 'teacher' && whoPerformed === 'teacher')) {
                                undoButton = `<button onclick="undoRecoverStudent(${logIndex})" class="undo-btn" style="background-color: #f44336; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; margin-top: 10px;">Undo Recover</button>`;
                            }
                            break;
                    }
                }
                
                switch(logEntry.action) {
                    case 'add':
                        actionDetails = `
                            <div class="modal-section">
                                <label class="modal-label">Action:</label>
                                <span class="modal-value" style="color: #4CAF50; font-weight: bold;">Student Added</span>
                            </div>
                            <div class="modal-section">
                                <label class="modal-label">Added By:</label>
                                <span class="modal-value">${logEntry.who}</span>
                            </div>
                            <div class="modal-section">
                                <label class="modal-label">Added At:</label>
                                <span class="modal-value">${logEntry.when}</span>
                            </div>
                        `;
                        break;
                    case 'edit':
                        // Find which fields actually changed
                        const original = logEntry.original_student;
                        const changed = [];
                        
                        if (original.name !== student.name) changed.push('name');
                        if (original.age !== student.age) changed.push('age');
                        if (original.class !== student.class) changed.push('class');
                        if (original.roll !== student.roll) changed.push('roll');
                        if (original.marks.math !== student.marks.math) changed.push('math');
                        if (original.marks.science !== student.marks.science) changed.push('science');
                        if (original.marks.history !== student.marks.history) changed.push('history');
                        if (original.marks.english !== student.marks.english) changed.push('english');
                        
                        let changesHTML = '';
                        if (changed.length > 0) {
                            changesHTML = `
                                <div style="display: flex; gap: 20px;">
                                    <div style="flex: 1;">
                                        <h4 style="color: #f44336; margin-bottom: 10px;">Before Edit</h4>
                                        ${changed.includes('name') ? `<div style="margin: 5px 0;"><strong>Name:</strong> ${original.name}</div>` : ''}
                                        ${changed.includes('age') ? `<div style="margin: 5px 0;"><strong>Age:</strong> ${original.age}</div>` : ''}
                                        ${changed.includes('class') ? `<div style="margin: 5px 0;"><strong>Class:</strong> ${original.class}</div>` : ''}
                                        ${changed.includes('roll') ? `<div style="margin: 5px 0;"><strong>Roll:</strong> ${original.roll}</div>` : ''}
                                        ${changed.includes('math') ? `<div style="margin: 5px 0;"><strong>Math:</strong> ${original.marks.math || 'N/A'} (${original.marks.math ? calculateGrade(original.marks.math) : 'N/A'})</div>` : ''}
                                        ${changed.includes('science') ? `<div style="margin: 5px 0;"><strong>Science:</strong> ${original.marks.science || 'N/A'} (${original.marks.science ? calculateGrade(original.marks.science) : 'N/A'})</div>` : ''}
                                        ${changed.includes('history') ? `<div style="margin: 5px 0;"><strong>History:</strong> ${original.marks.history || 'N/A'} (${original.marks.history ? calculateGrade(original.marks.history) : 'N/A'})</div>` : ''}
                                        ${changed.includes('english') ? `<div style="margin: 5px 0;"><strong>English:</strong> ${original.marks.english || 'N/A'} (${original.marks.english ? calculateGrade(original.marks.english) : 'N/A'})</div>` : ''}
                                    </div>
                                    <div style="flex: 1;">
                                        <h4 style="color: #4CAF50; margin-bottom: 10px;">After Edit</h4>
                                        ${changed.includes('name') ? `<div style="margin: 5px 0;"><strong>Name:</strong> ${student.name}</div>` : ''}
                                        ${changed.includes('age') ? `<div style="margin: 5px 0;"><strong>Age:</strong> ${student.age}</div>` : ''}
                                        ${changed.includes('class') ? `<div style="margin: 5px 0;"><strong>Class:</strong> ${student.class}</div>` : ''}
                                        ${changed.includes('roll') ? `<div style="margin: 5px 0;"><strong>Roll:</strong> ${student.roll}</div>` : ''}
                                        ${changed.includes('math') ? `<div style="margin: 5px 0;"><strong>Math:</strong> ${student.marks.math || 'N/A'} (${student.marks.math ? calculateGrade(student.marks.math) : 'N/A'})</div>` : ''}
                                        ${changed.includes('science') ? `<div style="margin: 5px 0;"><strong>Science:</strong> ${student.marks.science || 'N/A'} (${student.marks.science ? calculateGrade(student.marks.science) : 'N/A'})</div>` : ''}
                                        ${changed.includes('history') ? `<div style="margin: 5px 0;"><strong>History:</strong> ${student.marks.history || 'N/A'} (${student.marks.history ? calculateGrade(student.marks.history) : 'N/A'})</div>` : ''}
                                        ${changed.includes('english') ? `<div style="margin: 5px 0;"><strong>English:</strong> ${student.marks.english || 'N/A'} (${student.marks.english ? calculateGrade(student.marks.english) : 'N/A'})</div>` : ''}
                                    </div>
                                </div>
                            `;
                        } else {
                            changesHTML = '<div style="color: #666; font-style: italic;">No changes detected</div>';
                        }
                        
                        actionDetails = `
                            <div class="modal-section">
                                <label class="modal-label">Action:</label>
                                <span class="modal-value" style="color: #FF9800; font-weight: bold;">Student Edited</span>
                            </div>
                            <div class="modal-section">
                                <label class="modal-label">Edited By:</label>
                                <span class="modal-value">${logEntry.who}</span>
                            </div>
                            <div class="modal-section">
                                <label class="modal-label">Edited At:</label>
                                <span class="modal-value">${logEntry.when}</span>
                            </div>
                            <div class="modal-section">
                                <label class="modal-label">Changes:</label>
                                <div style="margin-top: 10px;">
                                    ${changesHTML}
                                </div>
                            </div>
                        `;
                        break;
                    case 'delete':
                        actionDetails = `
                            <div class="modal-section">
                                <label class="modal-label">Action:</label>
                                <span class="modal-value" style="color: #f44336; font-weight: bold;">Student Deleted</span>
                            </div>
                            <div class="modal-section">
                                <label class="modal-label">Deleted By:</label>
                                <span class="modal-value">${logEntry.who}</span>
                            </div>
                            <div class="modal-section">
                                <label class="modal-label">Deleted At:</label>
                                <span class="modal-value">${logEntry.when}</span>
                            </div>
                        `;
                        break;
                    case 'recover':
                        actionDetails = `
                            <div class="modal-section">
                                <label class="modal-label">Action:</label>
                                <span class="modal-value" style="color: #2196F3; font-weight: bold;">Student Recovered</span>
                            </div>
                            <div class="modal-section">
                                <label class="modal-label">Recovered By:</label>
                                <span class="modal-value">${logEntry.who}</span>
                            </div>
                            <div class="modal-section">
                                <label class="modal-label">Recovered At:</label>
                                <span class="modal-value">${logEntry.when}</span>
                            </div>
                        `;
                        break;
                    case 'permadelete':
                        actionDetails = `
                            <div class="modal-section">
                                <label class="modal-label">Action:</label>
                                <span class="modal-value" style="color: #9C27B0; font-weight: bold;">Student Permanently Deleted</span>
                            </div>
                            <div class="modal-section">
                                <label class="modal-label">Deleted By:</label>
                                <span class="modal-value">${logEntry.who}</span>
                            </div>
                            <div class="modal-section">
                                <label class="modal-label">Deleted At:</label>
                                <span class="modal-value">${logEntry.when}</span>
                            </div>
                        `;
                        break;
                    case 'change_teacher_password':
                        // Check if current user can view password details
                        const canViewPasswords = currentUserRole === 'principal' || 
                                               (currentUserRole === 'teacher' && currentUser && currentUser.username === logEntry.teacher_username);
                        
                        let passwordDetailsHTML = '';
                        if (canViewPasswords) {
                            passwordDetailsHTML = `
                                <div class="modal-section">
                                    <label class="modal-label">Password Change:</label>
                                    <div style="margin-top: 10px;">
                                        <div style="display: flex; gap: 20px;">
                                            <div style="flex: 1;">
                                                <h4 style="color: #f44336; margin-bottom: 10px;">Old Password</h4>
                                                <div style="font-family: monospace; background: #f5f5f5; padding: 8px; border-radius: 4px;">${logEntry.old_password}</div>
                                            </div>
                                            <div style="flex: 1;">
                                                <h4 style="color: #4CAF50; margin-bottom: 10px;">New Password</h4>
                                                <div style="font-family: monospace; background: #f5f5f5; padding: 8px; border-radius: 4px;">${logEntry.new_password}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        } else {
                            passwordDetailsHTML = `
                                <div class="modal-section">
                                    <label class="modal-label">Password Change:</label>
                                    <div style="margin-top: 10px;">
                                        <div style="color: #666; font-style: italic; background: #f5f5f5; padding: 12px; border-radius: 4px; text-align: center;">
                                            Password details are only visible to the principal and the affected teacher.
                                        </div>
                                    </div>
                                </div>
                            `;
                        }
                        
                        actionDetails = `
                            <div class="modal-section">
                                <label class="modal-label">Action:</label>
                                <span class="modal-value" style="color: #FF9800; font-weight: bold;">Teacher Password Updated</span>
                            </div>
                            <div class="modal-section">
                                <label class="modal-label">Teacher:</label>
                                <span class="modal-value">${logEntry.teacher_username}</span>
                            </div>
                            <div class="modal-section">
                                <label class="modal-label">Changed By:</label>
                                <span class="modal-value">${logEntry.who}</span>
                            </div>
                            <div class="modal-section">
                                <label class="modal-label">Changed At:</label>
                                <span class="modal-value">${logEntry.when}</span>
                            </div>
                            ${passwordDetailsHTML}
                        `;
                        break;
                    case 'add_teacher':
                        actionDetails = `
                            <div class="modal-section">
                                <label class="modal-label">Action:</label>
                                <span class="modal-value" style="color: #4CAF50; font-weight: bold;">Teacher Added</span>
                            </div>
                            <div class="modal-section">
                                <label class="modal-label">Teacher:</label>
                                <span class="modal-value">${logEntry.teacher ? logEntry.teacher.username : 'Unknown'}</span>
                            </div>
                            <div class="modal-section">
                                <label class="modal-label">Added By:</label>
                                <span class="modal-value">${logEntry.who}</span>
                            </div>
                            <div class="modal-section">
                                <label class="modal-label">Added At:</label>
                                <span class="modal-value">${logEntry.when}</span>
                            </div>
                        `;
                        break;
                    case 'update_marks':
                        actionDetails = `
                            <div class="modal-section">
                                <label class="modal-label">Action:</label>
                                <span class="modal-value" style="color: #FF9800; font-weight: bold;">Student Marks Updated</span>
                            </div>
                            <div class="modal-section">
                                <label class="modal-label">Student:</label>
                                <span class="modal-value">${logEntry.student ? logEntry.student.name : 'Unknown'}</span>
                            </div>
                            <div class="modal-section">
                                <label class="modal-label">Updated By:</label>
                                <span class="modal-value">${logEntry.who}</span>
                            </div>
                            <div class="modal-section">
                                <label class="modal-label">Updated At:</label>
                                <span class="modal-value">${logEntry.when}</span>
                            </div>
                            <div class="modal-section">
                                <label class="modal-label">Marks Changes:</label>
                                <div style="margin-top: 10px;">
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                        <div>
                                            <h4 style="color: #f44336; margin-bottom: 10px;">Previous Marks</h4>
                                            <div style="background: #f5f5f5; padding: 8px; border-radius: 4px;">
                                                <p><strong>Math:</strong> ${logEntry.original_marks ? logEntry.original_marks.math : 'N/A'}</p>
                                                <p><strong>Science:</strong> ${logEntry.original_marks ? logEntry.original_marks.science : 'N/A'}</p>
                                                <p><strong>History:</strong> ${logEntry.original_marks ? logEntry.original_marks.history : 'N/A'}</p>
                                                <p><strong>English:</strong> ${logEntry.original_marks ? logEntry.original_marks.english : 'N/A'}</p>
                                            </div>
                                        </div>
                                        <div>
                                            <h4 style="color: #4CAF50; margin-bottom: 10px;">Updated Marks</h4>
                                            <div style="background: #f5f5f5; padding: 8px; border-radius: 4px;">
                                                <p><strong>Math:</strong> ${logEntry.updated_marks ? logEntry.updated_marks.math : 'N/A'}</p>
                                                <p><strong>Science:</strong> ${logEntry.updated_marks ? logEntry.updated_marks.science : 'N/A'}</p>
                                                <p><strong>History:</strong> ${logEntry.updated_marks ? logEntry.updated_marks.history : 'N/A'}</p>
                                                <p><strong>English:</strong> ${logEntry.updated_marks ? logEntry.updated_marks.english : 'N/A'}</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        break;
                    case 'delete_teacher':
                        actionDetails = `
                            <div class="modal-section">
                                <label class="modal-label">Action:</label>
                                <span class="modal-value" style="color: #f44336; font-weight: bold;">Teacher Deleted</span>
                            </div>
                            <div class="modal-section">
                                <label class="modal-label">Teacher:</label>
                                <span class="modal-value">${logEntry.teacher ? logEntry.teacher.username : 'Unknown'}</span>
                            </div>
                            <div class="modal-section">
                                <label class="modal-label">Deleted By:</label>
                                <span class="modal-value">${logEntry.who}</span>
                            </div>
                            <div class="modal-section">
                                <label class="modal-label">Deleted At:</label>
                                <span class="modal-value">${logEntry.when}</span>
                            </div>
                        `;
                        break;
                }
                
                // Determine modal title and content based on action type
                let modalTitle = 'Log Details';
                let modalContent = '';
                
                if (['add', 'edit', 'delete', 'recover', 'permadelete'].includes(logEntry.action) && student) {
                    modalTitle = 'Student Details';
                    modalContent = `
                        <div class="modal-section">
                            <label class="modal-label">Name:</label>
                            <span class="modal-value">${student.name}</span>
                        </div>
                        <div class="modal-section">
                            <label class="modal-label">Age:</label>
                            <span class="modal-value">${student.age}</span>
                        </div>
                        <div class="modal-section">
                            <label class="modal-label">Class:</label>
                            <span class="modal-value">${student.class}</span>
                        </div>
                        <div class="modal-section">
                            <label class="modal-label">Roll Number:</label>
                            <span class="modal-value">${student.roll}</span>
                        </div>
                        <div class="modal-section">
                            <label class="modal-label">Marks & Grades:</label>
                            <span class="modal-value">
                                <div style="margin: 5px 0;">
                                    <strong>Math:</strong> ${student.marks.math || 'N/A'} marks (Grade: ${student.marks.math ? calculateGrade(student.marks.math) : 'N/A'})
                                </div>
                                <div style="margin: 5px 0;">
                                    <strong>Science:</strong> ${student.marks.science || 'N/A'} marks (Grade: ${student.marks.science ? calculateGrade(student.marks.science) : 'N/A'})
                                </div>
                                <div style="margin: 5px 0;">
                                    <strong>History:</strong> ${student.marks.history || 'N/A'} marks (Grade: ${student.marks.history ? calculateGrade(student.marks.history) : 'N/A'})
                                </div>
                                <div style="margin: 5px 0;">
                                    <strong>English:</strong> ${student.marks.english || 'N/A'} marks (Grade: ${student.marks.english ? calculateGrade(student.marks.english) : 'N/A'})
                                </div>
                            </span>
                        </div>
                    `;
                } else if (['change_teacher_password', 'add_teacher', 'delete_teacher'].includes(logEntry.action)) {
                    modalTitle = 'Teacher Details';
                    // For teacher actions, we don't need additional content beyond actionDetails
                }
                
                const modalOverlay = document.createElement('div');
                modalOverlay.className = 'modal-overlay';
                modalOverlay.innerHTML = `
                    <div class="modal-content">
                        <button class="modal-close" onclick="closeLogDetails()">&times;</button>
                        <h2>${modalTitle}</h2>
                        ${modalContent}
                        ${actionDetails}
                        ${undoButton ? `<div class="modal-actions">${undoButton}</div>` : ''}
                    </div>
                `;
                document.body.appendChild(modalOverlay);
                console.log('Modal created and added to DOM');
            })
            .catch(error => {
                console.error('Error fetching log data:', error);
                alert('Error loading log details');
            });
        }

        function closeLogDetails() {
            const modalOverlay = document.querySelector('.modal-overlay');
            if (modalOverlay) {
                modalOverlay.remove();
            }
        }



        // Teacher Management Functions
        function showTeacherManagement() {
            hideAllPages();
            document.getElementById('teacherManagementPage').style.display = 'block';
            updateNavigation('teachers');
            loadTeachers();
        }

        async function loadTeachers() {
            try {
                const response = await fetch('/api/teachers');
                if (response.ok) {
                    const teachers = await response.json();
                    displayTeachers(teachers);
                } else {
                    console.error('Error loading teachers:', response.status);
                }
            } catch (error) {
                console.error('Error loading teachers:', error);
            }
        }

        function displayTeachers(teachers) {
            const tableDiv = document.getElementById('teachersTable');
            if (teachers.length === 0) {
                tableDiv.innerHTML = '<p>No teachers found.</p>';
                return;
            }

            let html = `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Class</th>
                                <th style="width: 200px;">Password</th>
                                <th>Created At</th>
                                <th>Last Password Change</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            teachers.forEach((teacher) => {
                html += `
                    <tr>
                        <td>${teacher.username}</td>
                        <td>${teacher.class || 'N/A'}</td>
                        <td style="width: 200px;">
                            <span id="password-${teacher.username}" style="display: none;">${teacher.password}</span>
                            <span id="password-hidden-${teacher.username}">••••••••</span>
                            <button onclick="togglePasswordVisibility('${teacher.username}')" class="btn btn-secondary" style="margin-left: 10px; padding: 4px 8px; font-size: 12px;">
                                <span id="toggle-text-${teacher.username}">Show</span>
                            </button>
                        </td>
                        <td>${teacher.created_at}</td>
                        <td>${teacher.last_password_change}</td>
                        <td>
                            <button onclick="showTeacherDetails('${teacher.username}')" class="btn btn-primary">Manage</button>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table></div>';
            tableDiv.innerHTML = html;
        }

        function togglePasswordVisibility(username) {
            const passwordSpan = document.getElementById(`password-${username}`);
            const passwordHiddenSpan = document.getElementById(`password-hidden-${username}`);
            const toggleText = document.getElementById(`toggle-text-${username}`);
            
            if (passwordSpan.style.display === 'none') {
                // Show password
                passwordSpan.style.display = 'inline';
                passwordHiddenSpan.style.display = 'none';
                toggleText.textContent = 'Hide';
            } else {
                // Hide password
                passwordSpan.style.display = 'none';
                passwordHiddenSpan.style.display = 'inline';
                toggleText.textContent = 'Show';
            }
        }

        async function showAddTeacherForm() {
            try {
                const response = await fetch('/api/classes');
                const classes = await response.json();
                
                const classOptions = classes.map(cls => `<option value="${cls}">${cls}</option>`).join('');
                
                const form = `
                    <div id="addTeacherModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;">
                        <div style="background: white; padding: 30px; border-radius: 10px; width: 400px;">
                            <h3>Add New Teacher</h3>
                            <div style="margin: 15px 0;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Username</label>
                                <input type="text" id="teacherUsername" placeholder="Teacher Username" style="width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ccc; border-radius: 5px;">
                            </div>
                            <div style="margin: 15px 0;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Class</label>
                                <select id="teacherClass" style="width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ccc; border-radius: 5px;">
                                    <option value="">Select a class</option>
                                    ${classOptions}
                                </select>
                            </div>
                            <div style="margin: 15px 0;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Password</label>
                                <input type="password" id="teacherPassword" placeholder="Teacher Password" style="width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ccc; border-radius: 5px;">
                            </div>
                            <div style="display: flex; gap: 10px; margin-top: 20px;">
                                <button onclick="addTeacher()" style="flex: 1; padding: 10px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;">Add Teacher</button>
                                <button onclick="closeAddTeacherForm()" style="flex: 1; padding: 10px; background: #f44336; color: white; border: none; border-radius: 5px; cursor: pointer;">Cancel</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', form);
            } catch (error) {
                console.error('Error loading classes:', error);
                alert('Error loading available classes');
            }
        }

        function closeAddTeacherForm() {
            const modal = document.getElementById('addTeacherModal');
            if (modal) {
                modal.remove();
            }
        }

        function addTeacher() {
            const username = document.getElementById('teacherUsername').value;
            const teacherClass = document.getElementById('teacherClass').value;
            const password = document.getElementById('teacherPassword').value;
            
            if (!username || !teacherClass || !password) {
                alert('Please fill in all fields');
                return;
            }
            
            fetch('/api/teachers', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ username, class: teacherClass, password })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    closeAddTeacherForm();
                    loadTeachers();
                    alert('Teacher added successfully!');
                } else {
                    alert('Error adding teacher: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error adding teacher');
            });
        }

        function showChangePasswordForm(username) {
            const form = `
                <div id="changePasswordModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;">
                    <div style="background: white; padding: 30px; border-radius: 10px; width: 450px;">
                        <h3 style="margin-bottom: 20px; color: #1e293b;">Change Password for ${username}</h3>
                        
                        <div style="margin: 15px 0;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Your Password (Principal)</label>
                            <input type="password" id="principalPassword" placeholder="Enter your password to verify" style="width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ccc; border-radius: 5px;">
                        </div>
                        
                        <div style="margin: 15px 0;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">New Password for ${username}</label>
                            <input type="password" id="newPassword" placeholder="Enter new password" style="width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ccc; border-radius: 5px;">
                        </div>
                        
                        <div style="margin: 15px 0;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Confirm New Password</label>
                            <input type="password" id="confirmPassword" placeholder="Confirm new password" style="width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ccc; border-radius: 5px;">
                        </div>
                        
                        <div id="passwordError" style="color: #dc3545; margin: 10px 0; display: none;"></div>
                        
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button onclick="changeTeacherPassword('${username}')" style="flex: 1; padding: 10px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">Change Password</button>
                            <button onclick="closeChangePasswordForm()" style="flex: 1; padding: 10px; background: #f44336; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">Cancel</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', form);
        }

        function closeChangePasswordForm() {
            const modal = document.getElementById('changePasswordModal');
            if (modal) {
                modal.remove();
            }
        }

        function changeTeacherPassword(username) {
            const principalPassword = document.getElementById('principalPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const errorDiv = document.getElementById('passwordError');
            
            // Clear previous errors
            errorDiv.style.display = 'none';
            errorDiv.textContent = '';
            
            // Validation
            if (!principalPassword) {
                showPasswordError('Please enter your password to verify');
                return;
            }
            
            if (!newPassword) {
                showPasswordError('Please enter a new password');
                return;
            }
            
            if (!confirmPassword) {
                showPasswordError('Please confirm the new password');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showPasswordError('New passwords do not match');
                return;
            }
            
            if (newPassword.length < 6) {
                showPasswordError('New password must be at least 6 characters long');
                return;
            }
            
            // First verify principal's password
            fetch('/api/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    username: currentUser.username, 
                    password: principalPassword 
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showPasswordError('Your password is incorrect');
                    return;
                }
                
                // If principal password is correct, proceed with changing teacher password
                return fetch(`/api/teachers/${username}/change_password`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ new_password: newPassword })
                });
            })
            .then(response => {
                if (response) {
                    return response.json();
                }
            })
            .then(data => {
                if (data && data.success) {
                    closeChangePasswordForm();
                    loadTeachers();
                    alert('Password changed successfully!');
                } else if (data && data.error) {
                    showPasswordError('Error changing password: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showPasswordError('Error changing password');
            });
        }

        function showPasswordError(message) {
            const errorDiv = document.getElementById('passwordError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function deleteTeacher(username) {
            if (confirm(`Are you sure you want to delete teacher ${username}?`)) {
                fetch(`/api/teachers/${username}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        loadTeachers();
                        alert('Teacher deleted successfully!');
                    } else {
                        alert('Error deleting teacher: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error deleting teacher');
                });
            }
        }

        function showTeacherDetails(username) {
            // Find the teacher data
            fetch('/api/teachers')
            .then(response => response.json())
            .then(teachers => {
                const teacher = teachers.find(t => t.username === username);
                if (!teacher) {
                    alert('Teacher not found');
                    return;
                }

                const modalOverlay = document.createElement('div');
                modalOverlay.className = 'modal-overlay';
                modalOverlay.innerHTML = `
                    <div class="modal-content" style="max-width: 600px;">
                        <button class="modal-close" onclick="closeTeacherDetails()">&times;</button>
                        <h2 style="margin-bottom: 20px; color: #1e293b;">Teacher Details</h2>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                            <div>
                                <h3 style="color: #374151; margin-bottom: 10px;">Basic Information</h3>
                                <div style="background: #f8fafc; padding: 15px; border-radius: 8px;">
                                    <p><strong>Username:</strong> ${teacher.username}</p>
                                    <p><strong>Role:</strong> ${teacher.role}</p>
                                    <p><strong>Created:</strong> ${teacher.created_at}</p>
                                    <p><strong>Last Password Change:</strong> ${teacher.last_password_change}</p>
                                </div>
                            </div>
                            
                            <div>
                                <h3 style="color: #374151; margin-bottom: 10px;">Password</h3>
                                <div style="background: #f8fafc; padding: 15px; border-radius: 8px;">
                                    <p><strong>Current Password:</strong></p>
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <span id="detail-password-${teacher.username}" style="display: none; font-family: monospace;">${teacher.password}</span>
                                        <span id="detail-password-hidden-${teacher.username}" style="font-family: monospace;">••••••••</span>
                                        <button onclick="toggleDetailPasswordVisibility('${teacher.username}')" class="btn btn-secondary" style="padding: 4px 8px; font-size: 12px;">
                                            <span id="detail-toggle-text-${teacher.username}">Show</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="border-top: 1px solid #e5e7eb; padding-top: 20px;">
                            <h3 style="color: #374151; margin-bottom: 15px;">Actions</h3>
                            <div style="display: flex; gap: 15px;">
                                <button onclick="showChangePasswordForm('${teacher.username}')" class="btn btn-warning" style="flex: 1;">
                                    Change Password
                                </button>
                                <button onclick="deleteTeacher('${teacher.username}')" class="btn btn-danger" style="flex: 1;">
                                    Delete Teacher
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modalOverlay);
            })
            .catch(error => {
                console.error('Error loading teacher details:', error);
                alert('Error loading teacher details');
            });
        }

        function closeTeacherDetails() {
            const modalOverlay = document.querySelector('.modal-overlay');
            if (modalOverlay) {
                modalOverlay.remove();
            }
        }

        function toggleDetailPasswordVisibility(username) {
            const passwordSpan = document.getElementById(`detail-password-${username}`);
            const passwordHiddenSpan = document.getElementById(`detail-password-hidden-${username}`);
            const toggleText = document.getElementById(`detail-toggle-text-${username}`);
            
            if (passwordSpan.style.display === 'none') {
                // Show password
                passwordSpan.style.display = 'inline';
                passwordHiddenSpan.style.display = 'none';
                toggleText.textContent = 'Hide';
            } else {
                // Hide password
                passwordSpan.style.display = 'none';
                passwordHiddenSpan.style.display = 'inline';
                toggleText.textContent = 'Show';
            }
        }

        // Teacher Dashboard Functions
        function showTeacherDashboard() {
            hideAllPages();
            document.getElementById('teacherDashboardPage').style.display = 'block';
            updateNavigation('teacher-dashboard');
            loadTeacherStudents();
        }

        async function loadTeacherStudents() {
            try {
                const response = await fetch('/api/teacher/students');
                if (response.ok) {
                    teacherStudents = await response.json();
                    sortDirection = 'asc'; // Reset to ascending for new data
                    updateReverseButton();
                    sortStudents();
                } else {
                    const error = await response.json();
                    console.error('Error loading teacher students:', error);
                    document.getElementById('teacherStudentsTable').innerHTML = `<p style="color: #f44336;">Error: ${error.error}</p>`;
                }
            } catch (error) {
                console.error('Error loading teacher students:', error);
                document.getElementById('teacherStudentsTable').innerHTML = '<p style="color: #f44336;">Error loading students</p>';
            }
        }

        function sortStudents() {
            if (!teacherStudents || teacherStudents.length === 0) {
                return;
            }

            const sortBy = document.getElementById('sortSelect').value;
            const sortedStudents = [...teacherStudents];

            switch (sortBy) {
                case 'name':
                    sortedStudents.sort((a, b) => {
                        const result = a.name.localeCompare(b.name);
                        return sortDirection === 'asc' ? result : -result;
                    });
                    break;
                case 'age':
                    sortedStudents.sort((a, b) => {
                        const result = a.age - b.age;
                        return sortDirection === 'asc' ? result : -result;
                    });
                    break;
                case 'average':
                    sortedStudents.sort((a, b) => {
                        const result = b.average_marks - a.average_marks;
                        return sortDirection === 'asc' ? result : -result;
                    });
                    break;
                case 'math':
                    sortedStudents.sort((a, b) => {
                        const result = b.marks.math - a.marks.math;
                        return sortDirection === 'asc' ? result : -result;
                    });
                    break;
                case 'science':
                    sortedStudents.sort((a, b) => {
                        const result = b.marks.science - a.marks.science;
                        return sortDirection === 'asc' ? result : -result;
                    });
                    break;
                case 'history':
                    sortedStudents.sort((a, b) => {
                        const result = b.marks.history - a.marks.history;
                        return sortDirection === 'asc' ? result : -result;
                    });
                    break;
                case 'english':
                    sortedStudents.sort((a, b) => {
                        const result = b.marks.english - a.marks.english;
                        return sortDirection === 'asc' ? result : -result;
                    });
                    break;
                case 'roll':
                default:
                    sortedStudents.sort((a, b) => {
                        const result = a.roll - b.roll;
                        return sortDirection === 'asc' ? result : -result;
                    });
                    break;
            }

            displayTeacherStudents(sortedStudents);
        }

        function reverseSort() {
            sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            updateReverseButton();
            sortStudents();
        }

        function updateReverseButton() {
            const btn = document.getElementById('reverseSortBtn');
            if (sortDirection === 'asc') {
                btn.innerHTML = '↑';
                btn.title = 'Sort ascending (click to reverse)';
            } else {
                btn.innerHTML = '↓';
                btn.title = 'Sort descending (click to reverse)';
            }
        }

        function getMarkColor(mark) {
            if (mark >= 97) return '#2E7D32'; // Dark green for A+
            if (mark >= 93) return '#4CAF50'; // Green for A
            if (mark >= 90) return '#66BB6A'; // Light green for A-
            if (mark >= 87) return '#8BC34A'; // Lime green for B+
            if (mark >= 83) return '#9CCC65'; // Muted lime for B
            if (mark >= 80) return '#C0CA33'; // Olive green for B-
            if (mark >= 77) return '#D4E157'; // Light lime for C+
            if (mark >= 73) return '#E6EE9C'; // Very light lime for C
            if (mark >= 70) return '#F0F4C3'; // Pale lime for C-
            if (mark >= 67) return '#FF5722'; // Deep orange for D+
            if (mark >= 63) return '#E64A19'; // Dark orange for D
            if (mark >= 60) return '#D84315'; // Very dark orange for D-
            return '#D32F2F'; // Dark red for F
        }

        function displayTeacherStudents(students) {
            const tableDiv = document.getElementById('teacherStudentsTable');
            const classInfoDiv = document.getElementById('teacherClassInfo');
            
            if (students.length === 0) {
                tableDiv.innerHTML = '<p>No students found in your class.</p>';
                classInfoDiv.innerHTML = '';
                return;
            }

            // Show class information
            const teacherClass = students[0].class;
            classInfoDiv.innerHTML = `Class: ${teacherClass} | Total Students: ${students.length}`;

            // Get current sort option for visual indicators
            const currentSort = document.getElementById('sortSelect').value;

            let html = `
                <div class="table-container" style="overflow-x: auto; max-width: 100%;">
                    <table style="width: 100%;">
                        <thead>
                            <tr>
                                <th style="width: 15%; ${currentSort === 'name' ? 'background-color: #fff3cd; color: #495057; font-weight: bold;' : ''}">
                                    Name
                                </th>
                                <th style="width: 6%; ${currentSort === 'age' ? 'background-color: #fff3cd; color: #495057; font-weight: bold;' : ''}">
                                    Age
                                </th>
                                <th style="width: 10%; ${currentSort === 'roll' ? 'background-color: #fff3cd; color: #495057; font-weight: bold;' : ''}">
                                    Roll
                                </th>
                                <th style="width: 12%; ${currentSort === 'math' ? 'background-color: #fff3cd; color: #495057; font-weight: bold;' : ''}">
                                    Math
                                </th>
                                <th style="width: 12%; ${currentSort === 'science' ? 'background-color: #fff3cd; color: #495057; font-weight: bold;' : ''}">
                                    Science
                                </th>
                                <th style="width: 12%; ${currentSort === 'history' ? 'background-color: #fff3cd; color: #495057; font-weight: bold;' : ''}">
                                    History
                                </th>
                                <th style="width: 12%; ${currentSort === 'english' ? 'background-color: #fff3cd; color: #495057; font-weight: bold;' : ''}">
                                    English
                                </th>
                                <th style="width: 8%; ${currentSort === 'average' ? 'background-color: #fff3cd; color: #495057; font-weight: bold;' : ''}">
                                    Avg
                                </th>
                                <th style="width: 10%;">Attendance</th>
                                <th style="width: 13%;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            students.forEach((student, index) => {
                const mathGrade = student.grades.math;
                const scienceGrade = student.grades.science;
                const historyGrade = student.grades.history;
                const englishGrade = student.grades.english;
                const overallGrade = student.overall_grade;
                
                html += `
                    <tr>
                        <td style="padding: 6px; word-wrap: break-word; font-size: 13px;">
                            <span onclick="showProfilePicture(${student.roll}, '${student.name}')" 
                                  style="cursor: pointer; color: #333; font-weight: 500;"
                                  title="Click to view profile picture">
                                ${student.name}
                            </span>
                        </td>
                        <td style="padding: 6px; text-align: center; font-size: 13px;">${student.age}</td>
                        <td style="padding: 6px; text-align: center; font-size: 13px;">${student.roll}</td>
                                                                           <td style="padding: 6px; text-align: center;">
                            <div style="display: flex; flex-direction: column; align-items: center; gap: 2px;">
                                <span style="font-weight: bold; font-size: 13px; color: ${student.marks.math !== null ? getMarkColor(student.marks.math) : '#6c757d'};">
                                    ${student.marks.math !== null ? student.marks.math : 'N/A'}
                                </span>
                                <span style="color: ${student.marks.math !== null ? getMarkColor(student.marks.math) : '#6c757d'}; font-size: 10px; font-weight: bold;">
                                    ${mathGrade}
                                </span>
                            </div>
                        </td>
                        <td style="padding: 6px; text-align: center;">
                            <div style="display: flex; flex-direction: column; align-items: center; gap: 2px;">
                                <span style="font-weight: bold; font-size: 13px; color: ${student.marks.science !== null ? getMarkColor(student.marks.science) : '#6c757d'};">
                                    ${student.marks.science !== null ? student.marks.science : 'N/A'}
                                </span>
                                <span style="color: ${student.marks.science !== null ? getMarkColor(student.marks.science) : '#6c757d'}; font-size: 10px; font-weight: bold;">
                                    ${scienceGrade}
                                </span>
                            </div>
                        </td>
                        <td style="padding: 6px; text-align: center;">
                            <div style="display: flex; flex-direction: column; align-items: center; gap: 2px;">
                                <span style="font-weight: bold; font-size: 13px; color: ${student.marks.history !== null ? getMarkColor(student.marks.history) : '#6c757d'};">
                                    ${student.marks.history !== null ? student.marks.history : 'N/A'}
                                </span>
                                <span style="color: ${student.marks.history !== null ? getMarkColor(student.marks.history) : '#6c757d'}; font-size: 10px; font-weight: bold;">
                                    ${historyGrade}
                                </span>
                            </div>
                        </td>
                        <td style="padding: 6px; text-align: center;">
                            <div style="display: flex; flex-direction: column; align-items: center; gap: 2px;">
                                <span style="font-weight: bold; font-size: 13px; color: ${student.marks.english !== null ? getMarkColor(student.marks.english) : '#6c757d'};">
                                    ${student.marks.english !== null ? student.marks.english : 'N/A'}
                                </span>
                                <span style="color: ${student.marks.english !== null ? getMarkColor(student.marks.english) : '#6c757d'}; font-size: 10px; font-weight: bold;">
                                    ${englishGrade}
                                </span>
                            </div>
                        </td>
                        <td style="padding: 6px; text-align: center;">
                            <div style="display: flex; flex-direction: column; align-items: center; gap: 2px;">
                                <span style="font-weight: bold; font-size: 13px;">${student.average_marks !== null ? student.average_marks : 'N/A'}</span>
                                <span style="
                                    color: ${student.average_marks !== null ? getMarkColor(student.average_marks) : '#6c757d'}; 
                                    font-size: 10px; 
                                    font-weight: bold;
                                ">
                                    ${overallGrade}
                                </span>
                            </div>
                        </td>
                        <td style="padding: 6px; text-align: center;">
                            <div style="display: flex; flex-direction: column; align-items: center; gap: 2px;">
                                ${getAttendanceStatusDisplay(student)}
                                ${currentUser.role === 'principal' ? `
                                    <button onclick="showAttendanceAttempts(${student.roll})" style="
                                        padding: 1px 4px; 
                                        border-radius: 2px; 
                                        font-size: 8px; 
                                        font-weight: bold;
                                        color: white;
                                        background-color: #6c757d;
                                        border: none;
                                        cursor: pointer;
                                        margin-top: 2px;
                                    ">
                                        Details
                                    </button>
                                ` : ''}
                            </div>
                        </td>
                        <td style="padding: 6px; text-align: center;">
                            <button onclick="showUpdateMarksForm(${index})" class="btn btn-warning" style="padding: 3px 6px; font-size: 10px; white-space: nowrap;">Update</button>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table></div>';
            tableDiv.innerHTML = html;
        }

        function getAttendanceStatusDisplay(student) {
            const status = student.attendance_status || 'pending';
            const attempts = student.attendance_attempts || 3;
            
            switch(status) {
                case 'present':
                    return `
                        <span style="
                            padding: 2px 6px; 
                            border-radius: 3px; 
                            font-size: 10px; 
                            font-weight: bold;
                            color: white;
                            display: inline-block;
                            background-color: #4CAF50;
                        ">
                            ✅ Present
                        </span>
                    `;
                case 'absent':
                    return `
                        <span style="
                            padding: 2px 6px; 
                            border-radius: 3px; 
                            font-size: 10px; 
                            font-weight: bold;
                            color: white;
                            display: inline-block;
                            background-color: #f44336;
                        ">
                            ❌ Absent
                        </span>
                    `;
                case 'pending':
                    if (attempts < 3) {
                        return `
                            <span style="
                                padding: 2px 6px; 
                                border-radius: 3px; 
                                font-size: 10px; 
                                font-weight: bold;
                                color: white;
                                display: inline-block;
                                background-color: #FF9800;
                            ">
                                ⏳ ${attempts} attempts left
                            </span>
                        `;
                    } else {
                        return `
                            <span style="
                                padding: 2px 6px; 
                                border-radius: 3px; 
                                font-size: 10px; 
                                font-weight: bold;
                                color: white;
                                display: inline-block;
                                background-color: #6c757d;
                            ">
                                📝 No attempts
                            </span>
                        `;
                    }
                default:
                    return `
                        <span style="
                            padding: 2px 6px; 
                            border-radius: 3px; 
                            font-size: 10px; 
                            font-weight: bold;
                            color: white;
                            display: inline-block;
                            background-color: #6c757d;
                        ">
                            ❓ Unknown
                        </span>
                    `;
            }
        }

        async function showAttendanceAttempts(rollNumber) {
            try {
                const today = new Date().toISOString().split('T')[0];
                const response = await fetch(`/api/attendance/attempts/${rollNumber}?date=${today}`);
                const data = await response.json();
                
                let attemptsHtml = '';
                if (data.attempt_history && data.attempt_history.length > 0) {
                    attemptsHtml = data.attempt_history.map((attempt, index) => `
                        <div style="margin-bottom: 10px; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                            <div style="font-weight: bold; margin-bottom: 5px;">Attempt ${attempt.attempt_number}</div>
                            <div style="font-size: 12px; color: #666;">
                                <div>Time: ${new Date(attempt.timestamp).toLocaleString()}</div>
                                <div>Method: ${attempt.verification_result.method}</div>
                                <div>Result: ${attempt.verification_result.verified ? '✅ Success' : '❌ Failed'}</div>
                                <div>Reason: ${attempt.verification_result.reason}</div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    attemptsHtml = '<div style="color: #666; font-style: italic;">No attempts recorded yet.</div>';
                }
                
                const modal = `
                    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 1000;">
                        <div style="background: white; padding: 20px; border-radius: 10px; width: 500px; max-height: 80vh; overflow-y: auto;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h3 style="margin: 0; color: #374151;">📊 Attendance Attempts - Roll ${rollNumber}</h3>
                                <button onclick="this.parentElement.parentElement.parentElement.remove()" style="background: none; border: none; font-size: 20px; cursor: pointer; color: #666;">×</button>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <div style="display: flex; gap: 15px; margin-bottom: 10px;">
                                    <div>
                                        <strong>Status:</strong> 
                                        <span style="color: ${data.final_status === 'present' ? '#4CAF50' : data.final_status === 'absent' ? '#f44336' : '#FF9800'}; font-weight: bold;">
                                            ${data.final_status}
                                        </span>
                                    </div>
                                    <div>
                                        <strong>Attempts Remaining:</strong> 
                                        <span style="color: ${data.attempts_remaining > 0 ? '#4CAF50' : '#f44336'}; font-weight: bold;">
                                            ${data.attempts_remaining}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <h4 style="margin: 0 0 10px 0;">Attempt History</h4>
                                ${attemptsHtml}
                            </div>
                            
                            ${data.final_status === 'absent' ? `
                                <div style="margin-top: 15px; padding: 10px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px;">
                                    <strong>Override Options (Principal Only):</strong>
                                    <div style="margin-top: 10px; display: flex; gap: 10px;">
                                        <button onclick="overrideAttendance(${rollNumber}, 'present')" style="padding: 8px 16px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">
                                            Mark Present
                                        </button>
                                        <button onclick="this.parentElement.parentElement.parentElement.remove()" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">
                                            Cancel
                                        </button>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modal);
            } catch (error) {
                console.error('Error loading attendance attempts:', error);
                alert('Error loading attendance attempts');
            }
        }

        async function overrideAttendance(rollNumber, newStatus) {
            try {
                const today = new Date().toISOString().split('T')[0];
                const response = await fetch(`/api/attendance/override/${rollNumber}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        status: newStatus,
                        date: today
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`✅ Attendance status overridden to ${newStatus}`);
                    // Refresh teacher dashboard
                    showTeacherDashboard();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error('Error overriding attendance:', error);
                alert('Error overriding attendance');
            }
        }

        function showUpdateMarksForm(studentIndex) {
            // Get the student data from the current display
            const table = document.querySelector('#teacherStudentsTable table tbody');
            const rows = table.querySelectorAll('tr');
            const studentRow = rows[studentIndex];
            
            const name = studentRow.cells[0].textContent;
            const currentMath = studentRow.cells[3].querySelector('span').textContent;
            const currentScience = studentRow.cells[4].querySelector('span').textContent;
            const currentHistory = studentRow.cells[5].querySelector('span').textContent;
            const currentEnglish = studentRow.cells[6].querySelector('span').textContent;

            const form = `
                <div id="updateMarksModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;">
                    <div style="background: white; padding: 30px; border-radius: 10px; width: 400px;">
                        <h3>Update Marks for ${name}</h3>
                        <div style="margin: 15px 0;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Math Marks (0-100)</label>
                            <input type="number" id="updateMath" value="${currentMath}" min="0" max="100" style="width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ccc; border-radius: 5px;">
                        </div>
                        <div style="margin: 15px 0;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Science Marks (0-100)</label>
                            <input type="number" id="updateScience" value="${currentScience}" min="0" max="100" style="width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ccc; border-radius: 5px;">
                        </div>
                        <div style="margin: 15px 0;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">History Marks (0-100)</label>
                            <input type="number" id="updateHistory" value="${currentHistory}" min="0" max="100" style="width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ccc; border-radius: 5px;">
                        </div>
                        <div style="margin: 15px 0;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">English Marks (0-100)</label>
                            <input type="number" id="updateEnglish" value="${currentEnglish}" min="0" max="100" style="width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ccc; border-radius: 5px;">
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button onclick="updateStudentMarks(${studentIndex})" style="flex: 1; padding: 10px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;">Update Marks</button>
                            <button onclick="closeUpdateMarksForm()" style="flex: 1; padding: 10px; background: #f44336; color: white; border: none; border-radius: 5px; cursor: pointer;">Cancel</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', form);
        }

        function closeUpdateMarksForm() {
            const modal = document.getElementById('updateMarksModal');
            if (modal) {
                modal.remove();
            }
        }

        function updateStudentMarks(studentIndex) {
            const mathMarks = parseInt(document.getElementById('updateMath').value);
            const scienceMarks = parseInt(document.getElementById('updateScience').value);
            const historyMarks = parseInt(document.getElementById('updateHistory').value);
            const englishMarks = parseInt(document.getElementById('updateEnglish').value);
            
            if (isNaN(mathMarks) || isNaN(scienceMarks) || isNaN(historyMarks) || isNaN(englishMarks)) {
                alert('Please enter valid marks (0-100)');
                return;
            }
            
            if (mathMarks < 0 || mathMarks > 100 || scienceMarks < 0 || scienceMarks > 100 || 
                historyMarks < 0 || historyMarks > 100 || englishMarks < 0 || englishMarks > 100) {
                alert('Marks must be between 0 and 100');
                return;
            }
            
            const updatedMarks = {
                marks: {
                    math: mathMarks,
                    science: scienceMarks,
                    history: historyMarks,
                    english: englishMarks
                }
            };
            
            fetch(`/api/teacher/students/${studentIndex}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(updatedMarks)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    closeUpdateMarksForm();
                    loadTeacherStudents();
                    alert('Marks updated successfully!');
                } else {
                    alert('Error updating marks: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error updating marks');
            });
        }

        // Student Dashboard Functions
        function showStudentDashboard() {
            hideAllPages();
            document.getElementById('studentDashboardPage').style.display = 'block';
            updateStudentInfo();
            showStudentAttendance(); // Default to attendance page
        }

        function showStudentAttendance() {
            // Hide grades page
            document.getElementById('studentGradesPage').style.display = 'none';
            // Show attendance page
            document.getElementById('studentAttendancePage').style.display = 'block';
            
            // Update navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            document.querySelector('#studentAttendanceNav .nav-link').classList.add('active');
            
            // Load attendance data
            loadAttendanceHistory();
        }

        function showStudentGrades() {
            // Hide attendance page
            document.getElementById('studentAttendancePage').style.display = 'none';
            // Show grades page
            document.getElementById('studentGradesPage').style.display = 'block';
            
            // Update navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            document.querySelector('#studentGradesNav .nav-link').classList.add('active');
            
            // Load grades data
            loadStudentGrades();
        }

        function updateStudentInfo() {
            if (currentUser && currentUser.student_data) {
                const studentData = currentUser.student_data;
                document.getElementById('studentInfo').innerHTML = 
                    `Name: ${studentData.name} | Roll: ${studentData.roll} | Class: ${studentData.class} | Age: ${studentData.age}`;
                
                // Update main user info for students
                document.getElementById('userName').textContent = studentData.name;
                document.getElementById('userRole').textContent = `Class ${studentData.class}`;
                document.getElementById('userInitial').textContent = studentData.name.charAt(0).toUpperCase();
            }
        }

        // Webcam and Attendance Functions
        let stream = null;
        let video = null;
        let canvas = null;
        let ctx = null;

        async function startWebcam() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        facingMode: 'user'
                    } 
                });
                
                video = document.getElementById('webcam');
                video.srcObject = stream;
                
                document.getElementById('startWebcam').style.display = 'none';
                document.getElementById('markAttendance').style.display = 'inline-block';
                document.getElementById('stopWebcam').style.display = 'inline-block';
                
                // Initialize canvas
                canvas = document.getElementById('canvas');
                ctx = canvas.getContext('2d');
                canvas.width = 640;
                canvas.height = 480;
                
            } catch (error) {
                console.error('Error accessing webcam:', error);
                alert('Unable to access webcam. Please check permissions.');
            }
        }

        function stopWebcam() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            
            document.getElementById('startWebcam').style.display = 'inline-block';
            document.getElementById('markAttendance').style.display = 'none';
            document.getElementById('stopWebcam').style.display = 'none';
            
            const video = document.getElementById('webcam');
            video.srcObject = null;
        }

        async function markAttendance() {
            if (!video || !stream) {
                alert('Please start the camera first');
                return;
            }

            try {
                // Capture a frame from the video
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                // Convert canvas to base64 image
                const imageData = canvas.toDataURL('image/jpeg', 0.8);
                
                // Show processing status
                const statusDiv = document.getElementById('attendanceStatus');
                statusDiv.style.display = 'block';
                statusDiv.style.backgroundColor = '#fff3cd';
                statusDiv.style.color = '#856404';
                statusDiv.textContent = 'Processing attendance...';

                // Send attendance request to server with image
                const response = await fetch('/api/student/attendance', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        image_data: imageData
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    statusDiv.style.backgroundColor = '#d4edda';
                    statusDiv.style.color = '#155724';
                    if (result.auto_present) {
                        statusDiv.textContent = `✅ ${result.message}`;
                    } else {
                        statusDiv.textContent = result.message || 'Attendance image uploaded successfully! Waiting for teacher verification.';
                    }
                    
                    // Show attempts remaining
                    if (result.attempts_remaining !== undefined) {
                        const attemptsDiv = document.getElementById('attemptsRemaining');
                        if (attemptsDiv) {
                            if (result.attempts_remaining <= 0) {
                                attemptsDiv.style.backgroundColor = '#f8d7da';
                                attemptsDiv.style.color = '#721c24';
                                attemptsDiv.textContent = '❌ No attempts remaining. Contact your principal.';
                            } else {
                                attemptsDiv.style.backgroundColor = '#fff3cd';
                                attemptsDiv.style.color = '#856404';
                                attemptsDiv.textContent = `⚠️ ${result.attempts_remaining} attempts remaining`;
                            }
                        }
                    }
                    
                    // Reload attendance history and check attempts
                    loadAttendanceHistory();
                    checkAttemptsRemaining();
                } else {
                    statusDiv.style.backgroundColor = '#f8d7da';
                    statusDiv.style.color = '#721c24';
                    
                    if (result.reason === 'already_present') {
                        statusDiv.style.backgroundColor = '#d4edda';
                        statusDiv.style.color = '#155724';
                        statusDiv.textContent = result.message;
                    } else if (result.reason === 'no_attempts_left') {
                        statusDiv.textContent = result.message;
                        // Disable the mark attendance button
                        const markBtn = document.getElementById('markAttendance');
                        if (markBtn) {
                            markBtn.disabled = true;
                            markBtn.textContent = 'No Attempts Left';
                            markBtn.style.backgroundColor = '#6c757d';
                        }
                    } else if (result.reason === 'face_mismatch') {
                        statusDiv.textContent = result.message || 'Face mismatch. Please retake a clear photo looking straight at the camera.';
                    } else {
                        statusDiv.textContent = result.message || 'Failed to mark attendance';
                    }
                }
            } catch (error) {
                console.error('Error marking attendance:', error);
                const statusDiv = document.getElementById('attendanceStatus');
                statusDiv.style.display = 'block';
                statusDiv.style.backgroundColor = '#f8d7da';
                statusDiv.style.color = '#721c24';
                statusDiv.textContent = 'Network error. Please try again.';
            }
        }

        async function checkAttemptsRemaining() {
            try {
                const today = new Date().toISOString().split('T')[0];
                const response = await fetch(`/api/attendance/attempts/${currentUser.student_roll || currentUser.student_data?.roll}?date=${today}`);
                if (response.ok) {
                    const data = await response.json();
                    const attemptsDiv = document.getElementById('attemptsRemaining');
                    if (attemptsDiv) {
                        const remaining = data.attempts_remaining || 3;
                        if (remaining <= 0) {
                            attemptsDiv.style.backgroundColor = '#f8d7da';
                            attemptsDiv.style.color = '#721c24';
                            attemptsDiv.textContent = '❌ No attempts remaining. Contact your principal.';
                            attemptsDiv.style.display = 'block';
                            
                            // Disable the mark attendance button
                            const markBtn = document.getElementById('markAttendance');
                            if (markBtn) {
                                markBtn.disabled = true;
                                markBtn.textContent = 'No Attempts Left';
                                markBtn.style.backgroundColor = '#6c757d';
                            }
                        } else if (remaining < 3) {
                            attemptsDiv.style.backgroundColor = '#fff3cd';
                            attemptsDiv.style.color = '#856404';
                            attemptsDiv.textContent = `⚠️ ${remaining} attempts remaining`;
                            attemptsDiv.style.display = 'block';
                        }
                    }
                }
            } catch (error) {
                console.error('Error checking attempts remaining:', error);
            }
        }

        async function loadAttendanceHistory() {
            try {
                const response = await fetch('/api/student/attendance');
                if (response.ok) {
                    const attendanceData = await response.json();
                    displayAttendanceHistory(attendanceData);
                } else {
                    console.error('Error loading attendance history');
                }
            } catch (error) {
                console.error('Error loading attendance history:', error);
            }
        }

        function displayAttendanceHistory(attendanceData) {
            const container = document.getElementById('attendanceHistory');
            
            if (attendanceData.length === 0) {
                container.innerHTML = '<p>No attendance records found.</p>';
                return;
            }

            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px;">';
            
            attendanceData.forEach(record => {
                const date = new Date(record.date);
                const formattedDate = date.toLocaleDateString();
                let status, statusColor, backgroundColor;
                
                if (record.attended) {
                    status = 'Present';
                    statusColor = '#4CAF50';
                    backgroundColor = '#f0f8f0';
                } else if (record.uploaded) {
                    status = 'Uploaded';
                    statusColor = '#FF9800';
                    backgroundColor = '#fff8e1';
                } else {
                    status = 'Absent';
                    statusColor = '#f44336';
                    backgroundColor = '#fff5f5';
                }
                
                html += `
                    <div style="
                        padding: 10px; 
                        border: 1px solid #ddd; 
                        border-radius: 5px; 
                        text-align: center;
                        background: ${backgroundColor};
                    ">
                        <div style="font-weight: bold; margin-bottom: 5px;">${formattedDate}</div>
                        <div style="color: ${statusColor}; font-weight: bold;">${status}</div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        async function loadStudentGrades() {
            try {
                const response = await fetch('/api/student/grades');
                if (response.ok) {
                    const gradesData = await response.json();
                    displayStudentGrades(gradesData);
                } else {
                    console.error('Error loading student grades');
                    document.getElementById('studentGrades').innerHTML = '<p style="color: #f44336;">Error loading grades</p>';
                }
            } catch (error) {
                console.error('Error loading student grades:', error);
                document.getElementById('studentGrades').innerHTML = '<p style="color: #f44336;">Error loading grades</p>';
            }
        }

        function displayStudentGrades(gradesData) {
            const container = document.getElementById('studentGrades');
            
            const { student, marks, grades, average_marks, overall_grade } = gradesData;
            
            let html = `
                <div style="margin-bottom: 20px;">
                    <h4 style="color: #374151; margin-bottom: 10px;">Student Information</h4>
                    <div style="background: #f9fafb; padding: 15px; border-radius: 8px;">
                        <p><strong>Name:</strong> ${student.name}</p>
                        <p><strong>Roll Number:</strong> ${student.roll}</p>
                        <p><strong>Class:</strong> ${student.class}</p>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h4 style="color: #374151; margin-bottom: 15px;">Subject Grades</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
            `;
            
            // Display each subject
            const subjects = [
                { name: 'Mathematics', key: 'math' },
                { name: 'Science', key: 'science' },
                { name: 'History', key: 'history' },
                { name: 'English', key: 'english' }
            ];
            
            subjects.forEach(subject => {
                const mark = marks[subject.key];
                const grade = grades[subject.key];
                const color = getMarkColor(mark);
                
                html += `
                    <div style="
                        border: 1px solid #e5e7eb; 
                        border-radius: 8px; 
                        padding: 20px; 
                        text-align: center;
                        background: white;
                    ">
                        <h5 style="margin: 0 0 15px 0; color: #374151; font-size: 16px;">${subject.name}</h5>
                        <div style="font-size: 24px; font-weight: bold; color: ${color}; margin-bottom: 10px;">
                            ${mark}
                        </div>
                        <div style="
                            padding: 4px 12px; 
                            border-radius: 20px; 
                            font-size: 14px; 
                            font-weight: bold;
                            color: white;
                            display: inline-block;
                            background-color: ${color};
                        ">
                            ${grade}
                        </div>
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
                
                <div style="margin-top: 30px;">
                    <h4 style="color: #374151; margin-bottom: 15px;">Overall Performance</h4>
                    <div style="
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        padding: 25px;
                        border-radius: 12px;
                        text-align: center;
                    ">
                        <div style="font-size: 18px; margin-bottom: 10px;">Average Marks</div>
                        <div style="font-size: 36px; font-weight: bold; margin-bottom: 15px;">${average_marks}</div>
                        <div style="
                            padding: 6px 16px; 
                            border-radius: 25px; 
                            font-size: 16px; 
                            font-weight: bold;
                            background: rgba(255, 255, 255, 0.2);
                            display: inline-block;
                        ">
                            Overall Grade: ${overall_grade}
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }

        // Update hideAllPages to include student dashboard
        function hideAllPages() {
            document.getElementById('activeStudentsPage').style.display = 'none';
            document.getElementById('dataLogPage').style.display = 'none';
            document.getElementById('teacherManagementPage').style.display = 'none';
            document.getElementById('teacherDashboardPage').style.display = 'none';
            document.getElementById('studentDashboardPage').style.display = 'none';
        }

        async function showAttendanceImage(rollNumber) {
            try {
                // Get the current date and try to find attendance image for today or recent days
                const today = new Date().toISOString().split('T')[0];
                
                // Try today first, then recent days
                let response = await fetch(`/api/attendance/image/${today}/${rollNumber}`);
                
                if (!response.ok) {
                    // Try yesterday
                    const yesterday = new Date();
                    yesterday.setDate(yesterday.getDate() - 1);
                    const yesterdayStr = yesterday.toISOString().split('T')[0];
                    response = await fetch(`/api/attendance/image/${yesterdayStr}/${rollNumber}`);
                }
                
                if (!response.ok) {
                    // Try 2 days ago
                    const twoDaysAgo = new Date();
                    twoDaysAgo.setDate(twoDaysAgo.getDate() - 2);
                    const twoDaysAgoStr = twoDaysAgo.toISOString().split('T')[0];
                    response = await fetch(`/api/attendance/image/${twoDaysAgoStr}/${rollNumber}`);
                }
                
                if (!response.ok) {
                    // Try 3 days ago
                    const threeDaysAgo = new Date();
                    threeDaysAgo.setDate(threeDaysAgo.getDate() - 3);
                    const threeDaysAgoStr = threeDaysAgo.toISOString().split('T')[0];
                    response = await fetch(`/api/attendance/image/${threeDaysAgoStr}/${rollNumber}`);
                }
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Create modal to display image with verification buttons
                    const modal = `
                        <div id="attendanceImageModal" style="
                            position: fixed; 
                            top: 0; 
                            left: 0; 
                            width: 100%; 
                            height: 100%; 
                            background: rgba(0,0,0,0.8); 
                            display: flex; 
                            align-items: center; 
                            justify-content: center; 
                            z-index: 1000;
                        ">
                            <div style="
                                background: white; 
                                padding: 20px; 
                                border-radius: 10px; 
                                max-width: 90%; 
                                max-height: 90%;
                                text-align: center;
                            ">
                                <h3 style="margin-bottom: 15px;">Verify Attendance - Roll ${rollNumber}</h3>
                                <p style="margin-bottom: 15px; color: #666;">Please verify if this is the correct student</p>
                                <img src="${data.image_data}" style="
                                    max-width: 100%; 
                                    max-height: 60vh; 
                                    border-radius: 8px;
                                    border: 2px solid #ddd;
                                    margin-bottom: 20px;
                                " alt="Attendance Image">
                                <div style="display: flex; gap: 10px; justify-content: center; margin-bottom: 15px;">
                                    <button onclick="verifyAttendance(${rollNumber})" style="
                                        padding: 10px 20px; 
                                        background: #4CAF50; 
                                        color: white; 
                                        border: none; 
                                        border-radius: 5px; 
                                        cursor: pointer;
                                        font-weight: bold;
                                    ">
                                        Mark Present
                                    </button>
                                    <button onclick="requestNewImage(${rollNumber})" style="
                                        padding: 10px 20px; 
                                        background: #FF9800; 
                                        color: white; 
                                        border: none; 
                                        border-radius: 5px; 
                                        cursor: pointer;
                                        font-weight: bold;
                                    ">
                                        Request Another Image
                                    </button>
                                </div>
                                <div>
                                    <button onclick="closeAttendanceImageModal()" style="
                                        padding: 8px 16px; 
                                        background: #6c757d; 
                                        color: white; 
                                        border: none; 
                                        border-radius: 5px; 
                                        cursor: pointer;
                                    ">
                                        Close
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    document.body.insertAdjacentHTML('beforeend', modal);
                } else {
                    alert('Attendance image not found');
                }
            } catch (error) {
                console.error('Error loading attendance image:', error);
                alert('Error loading attendance image');
            }
        }

        function closeAttendanceImageModal() {
            const modal = document.getElementById('attendanceImageModal');
            if (modal) {
                modal.remove();
            }
        }

        async function verifyAttendance(rollNumber) {
            try {
                const response = await fetch(`/api/attendance/verify/${rollNumber}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    closeAttendanceImageModal();
                    // Reload teacher students to update the display
                    await loadTeacherStudents();
                    alert('Attendance verified successfully!');
                } else {
                    const error = await response.json();
                    alert(error.error || 'Failed to verify attendance');
                }
            } catch (error) {
                console.error('Error verifying attendance:', error);
                alert('Error verifying attendance');
            }
        }

        async function requestNewImage(rollNumber) {
            try {
                const response = await fetch(`/api/attendance/request-new/${rollNumber}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    closeAttendanceImageModal();
                    // Reload teacher students to update the display
                    await loadTeacherStudents();
                    alert('New image requested. Student will need to upload a new attendance image.');
                } else {
                    const error = await response.json();
                    alert(error.error || 'Failed to request new image');
                }
            } catch (error) {
                console.error('Error requesting new image:', error);
                alert('Error requesting new image');
            }
        }

        async function showAttendanceCalendar(rollNumber) {
            try {
                // Get student attendance data for the current month
                const today = new Date();
                const year = today.getFullYear();
                const month = today.getMonth();
                
                const response = await fetch(`/api/student/attendance/calendar/${rollNumber}?year=${year}&month=${month}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    displayAttendanceCalendar(rollNumber, data, year, month);
                } else {
                    const error = await response.json();
                    alert(error.error || 'Failed to load attendance calendar');
                }
            } catch (error) {
                console.error('Error loading attendance calendar:', error);
                alert('Error loading attendance calendar');
            }
        }

        function displayAttendanceCalendar(rollNumber, attendanceData, year, month) {
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                               'July', 'August', 'September', 'October', 'November', 'December'];
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDay = firstDay.getDay(); // 0 = Sunday, 1 = Monday, etc.
            
            let calendarHTML = `
                <div id="attendanceCalendarModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;">
                    <div style="background: white; padding: 30px; border-radius: 10px; width: 600px; max-height: 80vh; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3>Attendance Calendar - Roll ${rollNumber}</h3>
                            <button onclick="closeAttendanceCalendarModal()" style="background: #f44336; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer;">Close</button>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <h4 style="margin: 0; color: #374151;">${monthNames[month]} ${year}</h4>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; margin-bottom: 20px;">
                            <div style="padding: 10px; text-align: center; font-weight: bold; background: #f8f9fa; border: 1px solid #dee2e6;">Sun</div>
                            <div style="padding: 10px; text-align: center; font-weight: bold; background: #f8f9fa; border: 1px solid #dee2e6;">Mon</div>
                            <div style="padding: 10px; text-align: center; font-weight: bold; background: #f8f9fa; border: 1px solid #dee2e6;">Tue</div>
                            <div style="padding: 10px; text-align: center; font-weight: bold; background: #f8f9fa; border: 1px solid #dee2e6;">Wed</div>
                            <div style="padding: 10px; text-align: center; font-weight: bold; background: #f8f9fa; border: 1px solid #dee2e6;">Thu</div>
                            <div style="padding: 10px; text-align: center; font-weight: bold; background: #f8f9fa; border: 1px solid #dee2e6;">Fri</div>
                            <div style="padding: 10px; text-align: center; font-weight: bold; background: #f8f9fa; border: 1px solid #dee2e6;">Sat</div>
            `;
            
            // Add empty cells for days before the first day of the month
            for (let i = 0; i < startingDay; i++) {
                calendarHTML += `<div style="padding: 10px; text-align: center; background: #f8f9fa; border: 1px solid #dee2e6;"></div>`;
            }
            
            // Add days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const isPresent = attendanceData.present_dates.includes(dateStr);
                const isUploaded = attendanceData.uploaded_dates.includes(dateStr);
                const isToday = new Date().toDateString() === new Date(year, month, day).toDateString();
                
                let cellStyle = 'padding: 10px; text-align: center; border: 1px solid #dee2e6;';
                let cellContent = day;
                
                if (isToday) {
                    cellStyle += 'font-weight: bold; border: 2px solid #007bff;';
                }
                
                if (isPresent) {
                    cellStyle += 'background-color: #d4edda; color: #155724; font-weight: bold;';
                    cellContent = `${day} ✓`;
                } else if (isUploaded) {
                    cellStyle += 'background-color: #fff3cd; color: #856404; font-weight: bold;';
                    cellContent = `${day} ⏳`;
                } else if (new Date(year, month, day) <= new Date()) {
                    cellStyle += 'background-color: #f8d7da; color: #721c24; font-weight: bold;';
                    cellContent = `${day} ✗`;
                }
                
                calendarHTML += `<div style="${cellStyle}">${cellContent}</div>`;
            }
            
            calendarHTML += `
                        </div>
                        <div style="display: flex; gap: 20px; justify-content: center; margin-top: 20px;">
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <div style="width: 20px; height: 20px; background-color: #d4edda; border: 1px solid #c3e6cb;"></div>
                                <span>Present</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <div style="width: 20px; height: 20px; background-color: #fff3cd; border: 1px solid #ffeaa7;"></div>
                                <span>Uploaded (Pending)</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <div style="width: 20px; height: 20px; background-color: #f8d7da; border: 1px solid #f5c6cb;"></div>
                                <span>Absent</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', calendarHTML);
        }

        function closeAttendanceCalendarModal() {
            const modal = document.getElementById('attendanceCalendarModal');
            if (modal) {
                modal.remove();
            }
        }

        // Profile Picture Modal Functions
        async function showProfilePicture(studentRoll, studentName) {
            try {
                // Create modal HTML
                const modalHTML = `
                    <div id="profilePictureModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;">
                        <div style="background: white; padding: 30px; border-radius: 10px; width: 500px; text-align: center;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h3 style="margin: 0; color: #333;">${studentName}'s Profile Picture</h3>
                                <button onclick="closeProfilePictureModal()" style="background: #f44336; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; font-size: 18px;">&times;</button>
                            </div>
                            <div id="profilePictureContainer">
                                <img id="profilePictureImage" style="max-width: 100%; max-height: 400px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);" alt="Student Profile Picture">
                            </div>
                            <div id="noProfilePicture" style="display: none; padding: 40px; color: #666;">
                                <div style="font-size: 48px; margin-bottom: 20px;">📷</div>
                                <p>No profile picture available for this student.</p>
                                <p style="font-size: 14px; margin-top: 10px;">The student needs to log in and set up their profile picture.</p>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                
                // Fetch profile picture data
                const response = await fetch(`/api/student/profile-picture/${studentRoll}`);
                const data = await response.json();
                
                const imageElement = document.getElementById('profilePictureImage');
                const noPictureElement = document.getElementById('noProfilePicture');
                
                if (response.ok && data.profile_picture) {
                    imageElement.src = data.profile_picture;
                    imageElement.style.display = 'block';
                    noPictureElement.style.display = 'none';
                } else {
                    imageElement.style.display = 'none';
                    noPictureElement.style.display = 'block';
                }
                
            } catch (error) {
                console.error('Error loading profile picture:', error);
                // Show error state
                const imageElement = document.getElementById('profilePictureImage');
                const noPictureElement = document.getElementById('noProfilePicture');
                imageElement.style.display = 'none';
                noPictureElement.style.display = 'block';
                noPictureElement.innerHTML = `
                    <div style="font-size: 48px; margin-bottom: 20px;">❌</div>
                    <p>Error loading profile picture.</p>
                    <p style="font-size: 14px; margin-top: 10px;">Please try again later.</p>
                `;
            }
        }

        function closeProfilePictureModal() {
            const modal = document.getElementById('profilePictureModal');
            if (modal) {
                modal.remove();
            }
        }
    </script>
</body>
</html> 